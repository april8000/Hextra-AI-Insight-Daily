name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 0 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for new content
        id: check-updates
        run: |
          echo "ğŸ” æ£€æŸ¥æºä»“åº“ä¸­çš„æ–°å†…å®¹..."
          
          has_updates=false
          latest_date=""
          year_month=""
          
          if [ -d "source-repo/daily" ]; then
            echo "ğŸ“ æºä»“åº“dailyç›®å½•å­˜åœ¨ï¼Œå¼€å§‹æ£€æŸ¥æ–‡ä»¶..."
            
            # æŸ¥æ‰¾æœ€è¿‘3å¤©çš„æ–‡ä»¶
            for i in 0 1 2; do
              CHECK_DATE=$(date -d "-$i days" +%Y-%m-%d)
              YEAR_MONTH=$(date -d "-$i days" +%Y-%m)
              echo "æ£€æŸ¥æ—¥æœŸ: $CHECK_DATE (å¹´æœˆ: $YEAR_MONTH)"
              
              if [ -f "source-repo/daily/${CHECK_DATE}.md" ]; then
                echo "âœ… æ‰¾åˆ°æºæ–‡ä»¶: source-repo/daily/${CHECK_DATE}.md"
                
                # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
                TARGET_FILE="content/cn/${YEAR_MONTH}/${CHECK_DATE}.md"
                echo "æ£€æŸ¥ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
                
                if [ ! -f "$TARGET_FILE" ]; then
                  echo "ğŸ†• ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º: ${TARGET_FILE}"
                  has_updates=true
                  latest_date=$CHECK_DATE
                  year_month=$YEAR_MONTH
                  break
                else
                  echo "â„¹ï¸ ç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨: $TARGET_FILE"
                  # å¯ä»¥è¿›ä¸€æ­¥æ¯”è¾ƒå†…å®¹å·®å¼‚
                  SOURCE_SIZE=$(wc -c < "source-repo/daily/${CHECK_DATE}.md")
                  TARGET_SIZE=$(wc -c < "$TARGET_FILE")
                  echo "æºæ–‡ä»¶å¤§å°: ${SOURCE_SIZE} bytes, ç›®æ ‡æ–‡ä»¶å¤§å°: ${TARGET_SIZE} bytes"
                  
                  if [ "$SOURCE_SIZE" -ne "$TARGET_SIZE" ]; then
                    echo "ğŸ“ æ–‡ä»¶å¤§å°ä¸åŒï¼Œéœ€è¦æ›´æ–°"
                    has_updates=true
                    latest_date=$CHECK_DATE
                    year_month=$YEAR_MONTH
                    break
                  fi
                fi
              else
                echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: source-repo/daily/${CHECK_DATE}.md"
              fi
            done
            
            # è¾“å‡ºç»“æœ
            if [ "$has_updates" = true ]; then
              echo "âœ… å‘ç°éœ€è¦æ›´æ–°çš„å†…å®¹!"
              echo "latest_date=${latest_date}"
              echo "year_month=${year_month}"
              echo "has_updates=true" >> $GITHUB_OUTPUT
              echo "latest_date=${latest_date}" >> $GITHUB_OUTPUT
              echo "year_month=${year_month}" >> $GITHUB_OUTPUT
            else
              echo "â„¹ï¸ æ²¡æœ‰å‘ç°æ–°å†…å®¹æˆ–æ›´æ–°"
              echo "has_updates=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ æºä»“åº“ä¸­æ²¡æœ‰dailyç›®å½•"
            ls -la source-repo/ || echo "æ— æ³•åˆ—å‡ºæºä»“åº“ç›®å½•"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      - name: Process and convert content
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          LATEST_DATE=${{ steps.check-updates.outputs.latest_date }}
          YEAR_MONTH=${{ steps.check-updates.outputs.year_month }}
          
          echo "ğŸ“ å¼€å§‹å¤„ç†å†…å®¹..."
          echo "å¤„ç†æ—¥æœŸ: ${LATEST_DATE}"
          echo "ç›®æ ‡ç›®å½•: ${YEAR_MONTH}"
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p "content/cn/${YEAR_MONTH}"
          mkdir -p "content/en/${YEAR_MONTH}" 
          mkdir -p "content/ja/${YEAR_MONTH}"
          
          # å¤„ç†ä¸­æ–‡ç‰ˆæœ¬
          if [ -f "source-repo/daily/${LATEST_DATE}.md" ]; then
            echo "ğŸ”„ å¤„ç†ä¸­æ–‡ç‰ˆæœ¬..."
            
            TARGET_FILE="content/cn/${YEAR_MONTH}/${LATEST_DATE}.md"
            
            # ç”ŸæˆHugo Front Matter
            cat > "$TARGET_FILE" << EOF
---
title: "AIæ´å¯Ÿæ—¥æŠ¥ - ${LATEST_DATE}"
date: ${LATEST_DATE}T08:00:00+08:00
draft: false
tags: ["AI", "äººå·¥æ™ºèƒ½", "æŠ€æœ¯", "æ—¥æŠ¥"]
categories: ["AIæ—¥æŠ¥"]
weight: 1
---

EOF
            
            # æ·»åŠ åŸå§‹å†…å®¹
            cat "source-repo/daily/${LATEST_DATE}.md" >> "$TARGET_FILE"
            
            echo "âœ… ä¸­æ–‡ç‰ˆæœ¬å·²å¤„ç†: $TARGET_FILE"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < "$TARGET_FILE") bytes"
          else
            echo "âŒ æºæ–‡ä»¶ä¸å­˜åœ¨: source-repo/daily/${LATEST_DATE}.md"
          fi

      - name: Update index files
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          YEAR_MONTH=${{ steps.check-updates.outputs.year_month }}
          
          # æ›´æ–°æœˆä»½ç´¢å¼•æ–‡ä»¶
          INDEX_FILE="content/cn/${YEAR_MONTH}/_index.md"
          if [ ! -f "$INDEX_FILE" ]; then
            echo "ğŸ“„ åˆ›å»ºæœˆä»½ç´¢å¼•æ–‡ä»¶: $INDEX_FILE"
            cat > "$INDEX_FILE" << EOF
---
title: "${YEAR_MONTH} AIæ—¥æŠ¥"
date: ${YEAR_MONTH}-01T00:00:00+08:00
type: docs
weight: 1
---

# ${YEAR_MONTH} AIæ´å¯Ÿæ—¥æŠ¥

æœ¬æœˆçš„AIè¡Œä¸šåŠ¨æ€å’ŒæŠ€æœ¯è¶‹åŠ¿æ±‡æ€»ã€‚

EOF
            echo "âœ… æœˆä»½ç´¢å¼•æ–‡ä»¶å·²åˆ›å»º"
          else
            echo "â„¹ï¸ æœˆä»½ç´¢å¼•æ–‡ä»¶å·²å­˜åœ¨: $INDEX_FILE"
          fi

      - name: Commit and push changes
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          echo "ğŸ“¤ å‡†å¤‡æäº¤æ›´æ”¹..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ˜¾ç¤ºå¾…æäº¤çš„æ–‡ä»¶
          echo "å¾…æäº¤çš„æ–‡ä»¶:"
          git status --porcelain
          
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            echo "âœ… å‘ç°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°AIæ—¥æŠ¥å†…å®¹ - ${{ steps.check-updates.outputs.latest_date }}

            - æ¥æº: april8000/ai-insight-daily-token
            - æ—¥æœŸ: ${{ steps.check-updates.outputs.latest_date }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            "
            git push
            echo "ğŸ‰ å†…å®¹å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“!"
          fi

      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š æ‰§è¡Œæ€»ç»“:"
          echo "å·¥ä½œæµè§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "æ£€æŸ¥ç»“æœ: ${{ steps.check-updates.outputs.has_updates }}"
          
          if [ "${{ steps.check-updates.outputs.has_updates }}" == "true" ]; then
            echo "âœ… æˆåŠŸæ›´æ–°å†…å®¹!"
            echo "æ›´æ–°æ—¥æœŸ: ${{ steps.check-updates.outputs.latest_date }}"
            echo "ç›®æ ‡ç›®å½•: content/cn/${{ steps.check-updates.outputs.year_month }}/"
          else
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹"
          fi
          
          echo "å½“å‰ä»“åº“æ–‡ä»¶ç»“æ„:"
          find content -name "*.md" -type f | head -10 || echo "contentç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º"
