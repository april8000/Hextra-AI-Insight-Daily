name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup optimized content with enhanced visuals
        run: |
          echo "ğŸ¨ å¼€å§‹ä¼˜åŒ–ç‰ˆæœ¬å†…å®¹è®¾ç½®..."
          
          # ç¡®ä¿æ‰€æœ‰å¿…è¦ç›®å½•å­˜åœ¨
          mkdir -p content/cn
          mkdir -p assets/css
          mkdir -p static/images
          
          # åˆ›å»ºå¢å¼ºç‰ˆè‡ªå®šä¹‰CSS
          cat > assets/css/custom.css << 'EOF'
          /* AIæ´å¯Ÿæ—¥æŠ¥ - å¢å¼ºç‰ˆè§†è§‰æ ·å¼ */
          
          /* 1. åŸºç¡€æ ·å¼ä¼˜åŒ– */
          h1:first-of-type {
            display: none;
          }
          
          .content {
            max-width: none !important;
            overflow: visible !important;
            line-height: 1.8 !important;
          }
          
          /* 2. åˆ†ç±»æ ‡ç­¾è¶…çº§ç¾åŒ– */
          .content blockquote {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.05));
            border: none;
            border-left: 5px solid #ff9900;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin: 2rem 0;
            position: relative;
            box-shadow: 0 8px 32px rgba(255, 153, 0, 0.15);
            backdrop-filter: blur(10px);
          }
          
          .content blockquote::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff9900, #ffaa33, #ff9900);
            border-radius: 12px 12px 0 0;
            animation: shimmer 3s infinite;
          }
          
          @keyframes shimmer {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
          }
          
          .content blockquote p {
            margin: 0 !important;
            color: #ff9900 !important;
            font-weight: 600 !important;
            font-size: 1rem !important;
            text-shadow: 0 1px 2px rgba(255, 153, 0, 0.3);
          }
          
          .content blockquote code {
            background-color: rgba(255, 153, 0, 0.25) !important;
            color: #ff6600 !important;
            padding: 3px 8px !important;
            border-radius: 6px !important;
            font-weight: 700 !important;
            border: 1px solid rgba(255, 153, 0, 0.4) !important;
            box-shadow: 0 2px 4px rgba(255, 153, 0, 0.2);
          }
          
          /* 3. æ–°é—»æ¡ç›®è¶…çº§ç¾åŒ– */
          .content ol li,
          .content ul li {
            margin-bottom: 2rem !important;
            padding: 1.5rem !important;
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.05), rgba(255, 153, 0, 0.02)) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 153, 0, 0.2) !important;
            border-left: 4px solid #ff9900 !important;
            transition: all 0.4s ease !important;
            position: relative !important;
            box-shadow: 0 4px 16px rgba(255, 153, 0, 0.1) !important;
          }
          
          .content ol li:hover,
          .content ul li:hover {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.12), rgba(255, 153, 0, 0.05)) !important;
            transform: translateX(8px) translateY(-2px) !important;
            box-shadow: 0 8px 32px rgba(255, 153, 0, 0.25) !important;
            border-left-width: 6px !important;
          }
          
          .content ol li::before,
          .content ul li::before {
            content: 'ğŸ“°';
            position: absolute;
            top: -8px;
            left: 1rem;
            background: #ff9900;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(255, 153, 0, 0.3);
          }
          
          /* 4. æ ‡é¢˜è¶…çº§ç¾åŒ– */
          .content h3 {
            color: #ff9900 !important;
            background: linear-gradient(90deg, rgba(255, 153, 0, 0.1), transparent);
            border: none;
            border-left: 6px solid #ff9900;
            padding: 1rem 1.5rem !important;
            border-radius: 8px;
            margin: 2.5rem 0 1.5rem 0 !important;
            position: relative;
            box-shadow: 0 4px 16px rgba(255, 153, 0, 0.15);
            font-size: 1.3rem !important;
            font-weight: 700 !important;
          }
          
          .content h3::before {
            content: 'ğŸ”¥';
            margin-right: 0.8rem;
            font-size: 1.1rem;
          }
          
          .content h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #ff9900, transparent);
          }
          
          /* 5. é“¾æ¥è¶…çº§ç¾åŒ– */
          .content a {
            color: #ff9900 !important;
            text-decoration: none !important;
            font-weight: 600 !important;
            border-bottom: 2px solid transparent !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            padding: 2px 4px !important;
            border-radius: 4px !important;
          }
          
          .content a:hover {
            color: #ffffff !important;
            background: linear-gradient(45deg, #ff9900, #ffaa33) !important;
            border-bottom-color: transparent !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.4) !important;
          }
          
          .content a::after {
            content: ' ğŸ”—';
            font-size: 0.8em;
            opacity: 0.7;
          }
          
          /* 6. å¼ºè°ƒæ–‡æœ¬ç¾åŒ– */
          .content strong {
            color: #ff9900 !important;
            font-weight: 700 !important;
            background: linear-gradient(45deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.05)) !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            box-shadow: 0 1px 3px rgba(255, 153, 0, 0.2) !important;
          }
          
          /* 7. å›¾ç‰‡è¶…çº§ç¾åŒ– */
          .content img {
            margin: 2rem auto !important;
            border-radius: 16px !important;
            max-width: 100% !important;
            height: auto !important;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15) !important;
            transition: all 0.4s ease !important;
            border: 3px solid rgba(255, 153, 0, 0.2) !important;
          }
          
          .content img:hover {
            transform: scale(1.03) !important;
            box-shadow: 0 20px 60px rgba(255, 153, 0, 0.3) !important;
            border-color: #ff9900 !important;
          }
          
          /* 8. ä»£ç ç¾åŒ– */
          .content code {
            background: linear-gradient(45deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.08)) !important;
            color: #ff6600 !important;
            padding: 3px 8px !important;
            border-radius: 6px !important;
            font-size: 0.9em !important;
            font-weight: 600 !important;
            border: 1px solid rgba(255, 153, 0, 0.3) !important;
            box-shadow: 0 1px 3px rgba(255, 153, 0, 0.2) !important;
          }
          
          /* 9. åˆ†éš”çº¿ç¾åŒ– */
          .content hr {
            border: none !important;
            height: 3px !important;
            background: linear-gradient(90deg, transparent, #ff9900, transparent) !important;
            margin: 3rem 0 !important;
            border-radius: 2px !important;
          }
          
          /* 10. æš—è‰²ä¸»é¢˜è¶…çº§ä¼˜åŒ– */
          html.dark .content {
            color: #f0f0f0 !important;
          }
          
          html.dark .content h2,
          html.dark .content h3,
          html.dark .content h4 {
            color: #ff9900 !important;
          }
          
          html.dark .content ol li,
          html.dark .content ul li {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.12), rgba(255, 153, 0, 0.05)) !important;
            color: #f0f0f0 !important;
            border-color: rgba(255, 153, 0, 0.3) !important;
          }
          
          html.dark .content ol li:hover,
          html.dark .content ul li:hover {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.2), rgba(255, 153, 0, 0.08)) !important;
          }
          
          /* 11. å“åº”å¼è¶…çº§ä¼˜åŒ– */
          @media (max-width: 768px) {
            .content {
              padding: 1rem !important;
            }
            
            .content ol li,
            .content ul li {
              padding: 1rem !important;
              margin-bottom: 1.5rem !important;
            }
            
            .content blockquote {
              padding: 1rem 1.5rem !important;
            }
            
            .content h3 {
              font-size: 1.1rem !important;
              padding: 0.8rem 1rem !important;
            }
          }
          
          /* 12. åŠ è½½åŠ¨ç”» */
          .content {
            animation: fadeInUp 0.8s ease-out;
          }
          
          @keyframes fadeInUp {
            from {
              opacity: 0;
              transform: translateY(30px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          /* 13. ç‰¹æ®Šæ•ˆæœ */
          .content ol li:nth-child(odd),
          .content ul li:nth-child(odd) {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.08), rgba(255, 153, 0, 0.03)) !important;
          }
          
          .content ol li:nth-child(even),
          .content ul li:nth-child(even) {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.05), rgba(255, 153, 0, 0.02)) !important;
          }
          EOF
          
          echo "âœ… å¢å¼ºç‰ˆCSSå·²åˆ›å»º"
          
          # åˆ›å»ºæ ¹ç›®å½•é¦–é¡µ
          cat > content/_index.md << 'EOF'
          ---
          title: AIæ´å¯Ÿæ—¥æŠ¥
          ---
          
          # AIæ´å¯Ÿæ—¥æŠ¥
          
          **ç²¾é€‰AIæ–°é—»ä¸æ·±åº¦åˆ†æ** | æ¯æ—¥ä¸ºæ‚¨è¿‡æ»¤ä¿¡æ¯å™ªéŸ³ï¼Œæä¾›æœ€ç²¾é€‰çš„AIèµ„è®¯
          
          [æŸ¥çœ‹æœ€æ–°æ—¥æŠ¥ â†’](/cn/)
          EOF
          
          # åˆ›å»ºcnç›®å½•ä¸»é¡µ
          cat > content/cn/_index.md << 'EOF'
          ---
          title: AIæ´å¯Ÿæ—¥æŠ¥
          type: docs
          sidebar:
            open: true
          ---
          
          # AIæ´å¯Ÿæ—¥æŠ¥
          
          > ğŸ¤– **AIèµ„è®¯** | ğŸ“° **æ¯æ—¥æ—©è¯»** | ğŸŒ **å…¨ç½‘æ•°æ®èšåˆ** | ğŸ”¬ **å‰æ²¿ç§‘å­¦æ¢ç´¢** | ğŸ’¡ **å¼€æºåˆ›æ–°åŠ›é‡** | ğŸš€ **AIä¸äººç±»æœªæ¥**
          
          æ¬¢è¿æ¥åˆ°AIæ´å¯Ÿæ—¥æŠ¥ï¼è¿™é‡Œä¸ºæ‚¨æä¾›æ¯æ—¥ç²¾é€‰çš„AIèµ„è®¯å’Œæ·±åº¦åˆ†æã€‚
          
          ## ğŸ”¥ æœ€æ–°åŠ¨æ€
          
          æµè§ˆå·¦ä¾§çš„æ—¥æœŸå¯¼èˆªæŸ¥çœ‹æœ€æ–°çš„AIæ—¥æŠ¥å†…å®¹ï¼Œæ¯æ—¥æ›´æ–°ï¼Œç²¾å½©ä¸æ–­ï¼
          
          ### ğŸ“ˆ ä»Šæ—¥äº®ç‚¹
          - ğŸ’¡ **æ·±åº¦åˆ†æ** - ä¸“ä¸šè§£è¯»AIè¡Œä¸šè¶‹åŠ¿
          - ğŸ”— **åŸæ–‡é“¾æ¥** - ä¸€é”®è·³è½¬åˆ°æ–°é—»æºé¡µé¢
          - ğŸ¨ **è§†è§‰ä¼˜åŒ–** - ç²¾ç¾çš„é˜…è¯»ä½“éªŒ
          - ğŸ“± **å“åº”å¼è®¾è®¡** - å®Œç¾é€‚é…å„ç§è®¾å¤‡
          EOF
          
          # å¤„ç†æ—¥æŠ¥æ–‡ä»¶ - å¢å¼ºç‰ˆå¤„ç†
          find source-repo/daily -maxdepth 1 -type f -name "*.md" 2>/dev/null | sort -r | head -20 | while read -r SOURCE_FILE_PATH; do
            if [ -f "$SOURCE_FILE_PATH" ]; then
              FILENAME=$(basename "$SOURCE_FILE_PATH")
              DATE_PART=$(echo "$FILENAME" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')
              YEAR_MONTH=$(echo "$DATE_PART" | cut -c1-7)
              
              # æŒ‰å¹´æœˆåˆ›å»ºç›®å½•
              TARGET_DIR="content/cn/${YEAR_MONTH}"
              mkdir -p "$TARGET_DIR"
              TARGET_FILE="${TARGET_DIR}/${FILENAME}"
              
              echo "--- å¢å¼ºå¤„ç†æ–‡ä»¶: ${FILENAME} â†’ ${TARGET_FILE} ---"
              
              # è¯»å–å®Œæ•´åŸå§‹å†…å®¹
              ORIGINAL_CONTENT=$(cat "$SOURCE_FILE_PATH")
              
              # å¤„ç†å†…å®¹ä»¥ç¡®ä¿é“¾æ¥å®Œæ•´æ˜¾ç¤º
              PROCESSED_CONTENT=$(echo "$ORIGINAL_CONTENT" | sed 's/\[\([^]]*\)(\([^)]*\))\]/[\1](\2)/g')
              
              # æ ¹æ®å†…å®¹ç”Ÿæˆåˆ†ç±»æ ‡ç­¾
              CATEGORY_TAGS="\`AIèµ„è®¯\` | \`æ¯æ—¥æ—©è¯»\`"
              
              if echo "$ORIGINAL_CONTENT" | grep -qi "OpenAI\|ChatGPT\|GPT\|Claude\|Gemini"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`å¤§æ¨¡å‹å‰æ²¿\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "æŠ•èµ„\|èèµ„\|IPO\|ä¸Šå¸‚\|äº¿ç¾å…ƒ"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`å•†ä¸šåŠ¨æ€\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "å¼€æº\|GitHub\|ä»£ç "; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`å¼€æºåˆ›æ–°åŠ›é‡\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "ç ”ç©¶\|è®ºæ–‡\|å­¦æœ¯"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`å‰æ²¿ç§‘å­¦æ¢ç´¢\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "æœºå™¨äºº\|è‡ªåŠ¨é©¾é©¶"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`AIä¸äººç±»æœªæ¥\`"
              fi
              
              CATEGORY_TAGS="${CATEGORY_TAGS} | \`å…¨ç½‘æ•°æ®èšåˆ\`"
              
              # åˆ›å»ºå®Œæ•´çš„æ–‡ä»¶å†…å®¹
              cat > "$TARGET_FILE" << EOF
          ---
          linkTitle: $(echo $DATE_PART | cut -c6-10)-æ—¥æŠ¥
          title: "AIæ´å¯Ÿæ—¥æŠ¥ - ${DATE_PART}"
          date: ${DATE_PART}T08:00:00+08:00
          draft: false
          weight: 1
          type: docs
          sidebar:
            open: true
          description: "${DATE_PART}çš„AIè¡Œä¸šåŠ¨æ€ã€æŠ€æœ¯å‘å±•å’Œé‡è¦èµ„è®¯æ±‡æ€»"
          breadcrumbs: false
          comments: true
          ---
          
          ## AIæ´å¯Ÿæ—¥æŠ¥ ${DATE_PART}
          
          > ${CATEGORY_TAGS} | [è®¿é—®ç½‘é¡µç‰ˆâ†—ï¸](https://april8000.github.io/Hextra-AI-Insight-Daily/)
          
          ${PROCESSED_CONTENT}
          EOF
              
              echo "âœ… å¢å¼ºç‰ˆå†…å®¹æ–‡ä»¶å·²åˆ›å»º: ${TARGET_FILE}"
              
              # åˆ›å»ºæœˆä»½ç´¢å¼•
              MONTH_INDEX="${TARGET_DIR}/_index.md"
              if [ ! -f "$MONTH_INDEX" ]; then
                cat > "$MONTH_INDEX" << EOF
          ---
          title: "${YEAR_MONTH} AIæ—¥æŠ¥"
          date: ${YEAR_MONTH}-01T00:00:00+08:00
          type: docs
          sidebar:
            open: true
          weight: 1
          description: "${YEAR_MONTH}æœˆä»½AIè¡Œä¸šåŠ¨æ€æ±‡æ€»"
          ---
          
          # ${YEAR_MONTH} AIæ´å¯Ÿæ—¥æŠ¥
          
          > ğŸ“… **${YEAR_MONTH}** | ğŸ”¥ **æœˆåº¦ç²¾é€‰** | ğŸ“Š **æ•°æ®æ±‡æ€»** | ğŸ¯ **è¶‹åŠ¿åˆ†æ**
          
          ## ğŸ“ˆ æœ¬æœˆäº®ç‚¹
          
          æœ¬æœˆçš„AIè¡Œä¸šåŠ¨æ€å’ŒæŠ€æœ¯è¶‹åŠ¿æ±‡æ€»ï¼Œç²¾é€‰é‡è¦èµ„è®¯ï¼š
          
          - ğŸ”¥ **è¡Œä¸šçƒ­ç‚¹** - é‡å¤§çªç ´å’Œé‡Œç¨‹ç¢‘äº‹ä»¶
          - ğŸ› ï¸ **æŠ€æœ¯åˆ›æ–°** - æ–°äº§å“ã€æ–°åŠŸèƒ½ã€æ–°å¹³å°å‘å¸ƒ  
          - ğŸ“Š **å•†ä¸šåŠ¨æ€** - æŠ•èµ„èèµ„ã€å¹¶è´­é‡ç»„ã€å¸‚åœºåˆ†æ
          - ğŸ§  **å­¦æœ¯å‰æ²¿** - è®ºæ–‡å‘å¸ƒã€ç ”ç©¶çªç ´ã€æŠ€æœ¯è¿›å±•
          - ğŸ’¡ **å¼€æºç”Ÿæ€** - GitHubçƒ­é—¨é¡¹ç›®å’Œå¼€å‘è€…å·¥å…·
          - ğŸ¯ **è¡Œä¸šåº”ç”¨** - å‚ç›´é¢†åŸŸçš„AIè½åœ°å®è·µæ¡ˆä¾‹
          
          ---
          
          *ç‚¹å‡»å·¦ä¾§å¯¼èˆªæµè§ˆæœ¬æœˆå„æ—¥çš„è¯¦ç»†AIèµ„è®¯å†…å®¹*
          EOF
                echo "âœ… å¢å¼ºç‰ˆæœˆä»½ç´¢å¼•å·²åˆ›å»º: ${MONTH_INDEX}"
              fi
            fi
          done
          
          echo "--- å¢å¼ºç‰ˆè®¾ç½®å®Œæˆ ---"
          
          # æ˜¾ç¤ºæ–‡ä»¶ç»Ÿè®¡
          echo "=== å¢å¼ºç‰ˆç»Ÿè®¡ ==="
          echo "ğŸ“„ å†…å®¹æ–‡ä»¶: $(find content -name "*.md" -type f | wc -l)"
          echo "ğŸ¨ æ ·å¼æ–‡ä»¶: $(find assets -name "*.css" -type f | wc -l)"
          echo "ğŸ“Š å¹³å‡æ–‡ä»¶å¤§å°: $(find content/cn -name "*.md" -type f -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo '0') bytes"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "âœ¨ å¢å¼ºç‰ˆè§†è§‰ä¼˜åŒ–ï¼šè¶…çº§ç¾åŒ–+å®Œæ•´å†…å®¹+é“¾æ¥æ”¯æŒ - $(date +%Y-%m-%d-%H-%M)"
            git push
            echo "âœ… å¢å¼ºç‰ˆå·²æ¨é€"
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "ğŸ‰ å¢å¼ºç‰ˆè§†è§‰ä¼˜åŒ–å®Œæˆï¼"
          echo "âœ¨ è¶…çº§åŠŸèƒ½:"
          echo "   ğŸ¨ è¶…çº§ç¾åŒ–CSSï¼ˆæ¸å˜ã€é˜´å½±ã€åŠ¨ç”»ï¼‰"
          echo "   ğŸ“° å®Œæ•´å†…å®¹å±•ç¤ºï¼ˆä¸æˆªæ–­ï¼‰"
          echo "   ğŸ”— åŸæ–‡é“¾æ¥æ”¯æŒï¼ˆä¸€é”®è·³è½¬ï¼‰"
          echo "   ğŸ’« æ‚¬åœåŠ¨ç”»æ•ˆæœ"
          echo "   ğŸ“± å®Œç¾å“åº”å¼è®¾è®¡"
          echo "   ğŸŒ— å¢å¼ºæš—è‰²ä¸»é¢˜"
          echo "   âš¡ åŠ è½½åŠ¨ç”»æ•ˆæœ"
          echo "ğŸ“Š ç»Ÿè®¡: $(find content/cn -name "*.md" -type f | wc -l) ä¸ªå†…å®¹æ–‡ä»¶"
