name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup bulletproof content
        run: |
          echo "ğŸ”§ é˜²å¼¹ç‰ˆï¼šå®Œå…¨é¿å…æ‰€æœ‰shellç‰¹æ®Šå­—ç¬¦é—®é¢˜..."
          
          # ç¡®ä¿æ‰€æœ‰å¿…è¦ç›®å½•å­˜åœ¨
          mkdir -p content/cn
          mkdir -p assets/css
          mkdir -p static/images
          
          # åˆ›å»ºPythonè„šæœ¬æ–‡ä»¶ï¼ˆé¿å…HEREæ–‡æ¡£ï¼‰
          cat > process_content.py << 'PYTHON_SCRIPT'
          import re
          import os
          import sys
          
          def create_css():
              css_content = '''/* AIæ´å¯Ÿæ—¥æŠ¥ - é˜²å¼¹ç‰ˆ */
          
          h1:first-of-type {
            display: none;
          }
          
          .content {
            max-width: none !important;
            overflow: visible !important;
            line-height: 1.7 !important;
            word-wrap: break-word;
            word-break: break-word;
          }
          
          :root {
            --primary-color: #ff9900;
            --primary-light: #ffaa33;
            --primary-dark: #e68800;
          }
          
          /* åˆ†ç±»æ ‡ç­¾æ ·å¼ */
          .content blockquote {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.1), rgba(255, 153, 0, 0.03));
            border: none;
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            box-shadow: 0 2px 8px rgba(255, 153, 0, 0.1);
          }
          
          .content blockquote p {
            margin: 0 !important;
            color: var(--primary-color) !important;
            font-weight: 600 !important;
            font-size: 0.95rem !important;
          }
          
          .content blockquote code {
            background-color: rgba(255, 153, 0, 0.2) !important;
            color: var(--primary-dark) !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            font-weight: 600 !important;
            border: 1px solid rgba(255, 153, 0, 0.3) !important;
          }
          
          /* æ–°é—»æ¡ç›®æ ·å¼ */
          .content ol li,
          .content ul li {
            margin-bottom: 1.5rem !important;
            padding: 1.2rem !important;
            background: rgba(255, 153, 0, 0.02) !important;
            border-radius: 8px !important;
            border-left: 3px solid var(--primary-color) !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) !important;
          }
          
          .content ol li:hover,
          .content ul li:hover {
            background: rgba(255, 153, 0, 0.05) !important;
            transform: translateX(4px) !important;
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.15) !important;
          }
          
          /* åˆ†ç±»æ ‡é¢˜æ ·å¼ */
          .content h3 {
            color: var(--primary-color) !important;
            border-bottom: 2px solid rgba(255, 153, 0, 0.2);
            padding-bottom: 0.5rem;
            margin: 2rem 0 1rem 0 !important;
            font-weight: 700 !important;
          }
          
          /* é“¾æ¥æ ·å¼ */
          .content a {
            color: var(--primary-color) !important;
            text-decoration: none !important;
            font-weight: 500 !important;
            transition: all 0.2s ease !important;
          }
          
          .content a:hover {
            color: var(--primary-dark) !important;
            text-decoration: underline !important;
          }
          
          /* å¼ºè°ƒæ–‡æœ¬ */
          .content strong {
            color: var(--primary-color) !important;
            font-weight: 700 !important;
          }
          
          /* å›¾ç‰‡æ ·å¼ */
          .content img {
            margin: 1rem auto !important;
            border-radius: 8px !important;
            max-width: 100% !important;
            height: auto !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1) !important;
          }
          
          /* ä»£ç æ ·å¼ */
          .content code {
            background-color: rgba(255, 153, 0, 0.1) !important;
            color: var(--primary-dark) !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            font-size: 0.9em !important;
          }
          
          /* æ·±è‰²æ¨¡å¼æ ·å¼ */
          html.dark .content blockquote {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.05)) !important;
            border-left-color: #ff9900 !important;
            box-shadow: 0 4px 16px rgba(255, 153, 0, 0.2) !important;
          }
          
          html.dark .content blockquote p {
            color: #ff9900 !important;
          }
          
          html.dark .content blockquote code {
            background-color: rgba(255, 153, 0, 0.25) !important;
            color: #ffaa33 !important;
            border-color: rgba(255, 153, 0, 0.4) !important;
          }
          
          html.dark .content ol li,
          html.dark .content ul li {
            background: rgba(255, 153, 0, 0.08) !important;
            border-left-color: #ff9900 !important;
            color: #f0f0f0 !important;
            box-shadow: 0 2px 8px rgba(255, 153, 0, 0.1) !important;
          }
          
          html.dark .content ol li:hover,
          html.dark .content ul li:hover {
            background: rgba(255, 153, 0, 0.15) !important;
            box-shadow: 0 6px 20px rgba(255, 153, 0, 0.25) !important;
          }
          
          html.dark .content h2,
          html.dark .content h3,
          html.dark .content h4 {
            color: #ff9900 !important;
            border-bottom-color: rgba(255, 153, 0, 0.3) !important;
          }
          
          html.dark .content a {
            color: #ff9900 !important;
          }
          
          html.dark .content a:hover {
            color: #ffaa33 !important;
          }
          
          html.dark .content strong {
            color: #ff9900 !important;
          }
          
          html.dark .content code {
            background-color: #2a2a2a !important;
            color: #ff9900 !important;
            border: 1px solid #444 !important;
          }
          
          html.dark .content img {
            box-shadow: 0 8px 32px rgba(255, 153, 0, 0.15) !important;
          }
          
          /* å“åº”å¼è®¾è®¡ */
          @media (max-width: 768px) {
            .content {
              padding: 1rem !important;
            }
            
            .content ol li,
            .content ul li {
              padding: 1rem !important;
            }
            
            .content blockquote {
              padding: 1rem !important;
            }
          }
          '''
              with open('assets/css/custom.css', 'w', encoding='utf-8') as f:
                  f.write(css_content)
              print("âœ… é˜²å¼¹ç‰ˆCSSå·²åˆ›å»º")
          
          def create_index_files():
              # åˆ›å»ºæ ¹ç›®å½•é¦–é¡µ
              root_index = '''---
          title: AIæ´å¯Ÿæ—¥æŠ¥
          ---
          
          # AIæ´å¯Ÿæ—¥æŠ¥
          
          **ç²¾é€‰AIæ–°é—»ä¸æ·±åº¦åˆ†æ** | æ¯æ—¥ä¸ºæ‚¨è¿‡æ»¤ä¿¡æ¯å™ªéŸ³ï¼Œæä¾›æœ€ç²¾é€‰çš„AIèµ„è®¯
          
          [æŸ¥çœ‹æœ€æ–°æ—¥æŠ¥ â†’](/cn/)
          '''
              with open('content/_index.md', 'w', encoding='utf-8') as f:
                  f.write(root_index)
              
              # åˆ›å»ºcnç›®å½•ä¸»é¡µ
              cn_index = '''---
          linkTitle: AI Daily
          title: AI Daily-AIèµ„è®¯æ—¥æŠ¥
          breadcrumbs: false
          description: "ä¸ªäººæ¯æ—¥æ•´ç†çš„AIèµ„è®¯ç«™ã€‚æˆ‘ä»¬ä¸ºæ‚¨è¿‡æ»¤ä¿¡æ¯å™ªéŸ³ï¼Œåªæä¾›æœ€ç²¾é€‰çš„AIæ–°é—»ã€æœ€å®ç”¨çš„AIå·¥å…·ä¸AIæ•™ç¨‹ï¼ŒåŠ©æ‚¨é«˜æ•ˆè·å–äººå·¥æ™ºèƒ½é¢†åŸŸçš„å‰æ²¿åŠ¨æ€"
          cascade:
            type: docs
          ---
          
          ## AIèµ„è®¯æ—¥æŠ¥
          
          >  `AIèµ„è®¯` | `æ¯æ—¥æ—©è¯»` | `å…¨ç½‘æ•°æ®èšåˆ` | `å‰æ²¿ç§‘å­¦æ¢ç´¢` | `è¡Œä¸šè‡ªç”±å‘å£°` | `å¼€æºåˆ›æ–°åŠ›é‡` | `AIä¸äººç±»æœªæ¥` | [è®¿é—®ç½‘é¡µç‰ˆâ†—ï¸](https://april8000.github.io/Hextra-AI-Insight-Daily/)
          
          æ¬¢è¿æ¥åˆ°AIæ´å¯Ÿæ—¥æŠ¥ï¼è¿™é‡Œä¸ºæ‚¨æä¾›æ¯æ—¥ç²¾é€‰çš„AIèµ„è®¯å’Œæ·±åº¦åˆ†æã€‚
          
          ## ğŸ”¥ æœ€æ–°åŠ¨æ€
          
          æµè§ˆå·¦ä¾§çš„æ—¥æœŸå¯¼èˆªæŸ¥çœ‹æœ€æ–°çš„AIæ—¥æŠ¥å†…å®¹ï¼Œæ¯æ—¥æ›´æ–°ï¼Œç²¾å½©ä¸æ–­ï¼
          '''
              with open('content/cn/_index.md', 'w', encoding='utf-8') as f:
                  f.write(cn_index)
              print("âœ… é˜²å¼¹ç‰ˆç´¢å¼•æ–‡ä»¶å·²åˆ›å»º")
          
          def process_daily_content(source_file_path, target_file):
              # è¯»å– Worker ç”Ÿæˆçš„å®Œæ•´æ—¥æŠ¥å†…å®¹ï¼ˆåŒ…å«æ‘˜è¦å’Œæ‰€æœ‰åˆ†ç±»ï¼‰
              with open(source_file_path, "r", encoding="utf-8") as f:
                  content = f.read()
              
              # ä»æ–‡ä»¶åä¸­æå–æ—¥æœŸ
              filename = os.path.basename(source_file_path)
              date_match = re.search(r'(\d{4}-\d{2}-\d{2})', filename)
              if not date_match:
                  return False
              
              date_part = date_match.group(1)
              date_display = date_part.replace('-', '/')
              
              # ç›´æ¥ä½¿ç”¨å®Œæ•´æ—¥æŠ¥ï¼Œè€Œä¸æ˜¯é‡æ–°æ‹†åˆ†å’Œé‡ç»„æ‘˜è¦/åˆ†ç±»
              # è¿™é‡Œåªä¸º Hugo è¡¥å…… Front Matterï¼Œæ­£æ–‡ä¿æŒä¸é‚®ä»¶ç‰ˆ/åŸå§‹ Markdown å®Œå…¨ä¸€è‡´
              front_matter = f"""---
          linkTitle: {date_part[5:]}-æ—¥æŠ¥
          title: {date_part[5:]}-æ—¥æŠ¥-AIèµ„è®¯æ—¥æŠ¥
          weight: 1
          breadcrumbs: false
          comments: true
          description: "ä¸ªäººæ¯æ—¥æ•´ç†çš„AIèµ„è®¯ç«™ã€‚æˆ‘ä»¬ä¸ºæ‚¨è¿‡æ»¤ä¿¡æ¯å™ªéŸ³ï¼Œåªæä¾›æœ€ç²¾é€‰çš„AIæ–°é—»ã€æœ€å®ç”¨çš„AIå·¥å…·ä¸AIæ•™ç¨‹ï¼ŒåŠ©æ‚¨é«˜æ•ˆè·å–äººå·¥æ™ºèƒ½é¢†åŸŸçš„å‰æ²¿åŠ¨æ€"
          ---
          
          """
              
              # Hugo å†…å®¹ä¸»ä½“ï¼šç›´æ¥æ¥ä¸Šå®Œæ•´æ—¥æŠ¥ Markdown
              content_body = content
              
              # å†™å…¥æ–‡ä»¶
              os.makedirs(os.path.dirname(target_file), exist_ok=True)
              with open(target_file, "w", encoding="utf-8") as f:
                  f.write(front_matter + content_body)
              
              print(f"âœ… é˜²å¼¹ç‰ˆæ–‡ä»¶å·²åˆ›å»º: {target_file}")
              return True
          
          def create_month_index(target_dir, year_month):
              month_index_file = os.path.join(target_dir, '_index.md')
              if not os.path.exists(month_index_file):
                  month_index = f"""---
          title: "{year_month} AIæ—¥æŠ¥"
          date: {year_month}-01T00:00:00+08:00
          type: docs
          sidebar:
            open: true
          weight: 1
          ---
          
          # {year_month} AIæ´å¯Ÿæ—¥æŠ¥
          
          æœ¬æœˆçš„AIè¡Œä¸šåŠ¨æ€å’ŒæŠ€æœ¯è¶‹åŠ¿æ±‡æ€»ï¼Œç²¾é€‰é‡è¦èµ„è®¯ã€‚
          """
                  with open(month_index_file, 'w', encoding='utf-8') as f:
                      f.write(month_index)
                  print(f"âœ… æœˆä»½ç´¢å¼•å·²åˆ›å»º: {month_index_file}")
          
          if __name__ == "__main__":
              create_css()
              create_index_files()
              
              # å¤„ç†æ—¥æŠ¥æ–‡ä»¶
              import glob
              source_files = glob.glob("source-repo/daily/*.md")
              source_files.sort(reverse=True)
              
              for source_file_path in source_files[:20]:  # æœ€å¤šå¤„ç†20ä¸ªæ–‡ä»¶
                  filename = os.path.basename(source_file_path)
                  date_match = re.search(r'(\d{4}-\d{2}-\d{2})', filename)
                  if date_match:
                      date_part = date_match.group(1)
                      year_month = date_part[:7]
                      
                      target_dir = f"content/cn/{year_month}"
                      target_file = os.path.join(target_dir, filename)
                      
                      if process_daily_content(source_file_path, target_file):
                          create_month_index(target_dir, year_month)
              
              print("--- é˜²å¼¹ç‰ˆè®¾ç½®å®Œæˆ ---")
          PYTHON_SCRIPT
          
          echo "âœ… Pythonè„šæœ¬å·²åˆ›å»º"
          
          # è¿è¡ŒPythonè„šæœ¬
          python3 process_content.py
          
          echo "--- é˜²å¼¹ç‰ˆå¤„ç†å®Œæˆ ---"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸ”§ é˜²å¼¹ç‰ˆï¼šå®Œå…¨é¿å…shellç‰¹æ®Šå­—ç¬¦é—®é¢˜ - $(date +%Y-%m-%d-%H-%M)"
            git push
            echo "âœ… é˜²å¼¹ç‰ˆå·²æ¨é€"
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "ğŸ”§ é˜²å¼¹ç‰ˆå®Œæˆï¼"
          echo "âœ… ä¿®å¤å†…å®¹:"
          echo "   ğŸ›¡ï¸ ç‹¬ç«‹Pythonè„šæœ¬ï¼Œå®Œå…¨é¿å…shellè§£æ"
          echo "   ğŸ“ æ‰€æœ‰å­—ç¬¦ä¸²éƒ½åœ¨Pythonä¸­å¤„ç†"
          echo "   ğŸ”’ ä¸ä½¿ç”¨ä»»ä½•HEREæ–‡æ¡£å˜é‡æ›¿æ¢"
          echo "   ğŸ·ï¸ ä¿æŒå®Œæ•´çš„æ ‡ç­¾æ¡æ˜¾ç¤º"
          echo "   ğŸ“‚ ä¿æŒ5å¤§å›ºå®šåˆ†ç±»ç»“æ„"
          echo "   ğŸ¨ å®Œå…¨è¿˜åŸåŸä½œè€…æ ·å¼"
          echo "ğŸ“Š ç»Ÿè®¡: $(find content/cn -name "*.md" -type f | wc -l) ä¸ªå†…å®¹æ–‡ä»¶"
