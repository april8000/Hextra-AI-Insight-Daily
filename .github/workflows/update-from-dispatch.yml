name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 0 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Force sync all available content
        id: sync-content
        run: |
          echo "ğŸ”„ å¼ºåˆ¶åŒæ­¥æ‰€æœ‰å¯ç”¨å†…å®¹..."
          
          has_updates=false
          files_processed=0
          
          if [ -d "source-repo/daily" ]; then
            echo "ğŸ“ æºä»“åº“dailyç›®å½•å­˜åœ¨"
            echo "æºä»“åº“dailyç›®å½•å†…å®¹:"
            ls -la source-repo/daily/
            
            # éå†æ‰€æœ‰source-repo/dailyä¸­çš„.mdæ–‡ä»¶
            for source_file in source-repo/daily/*.md; do
              if [ -f "$source_file" ]; then
                # æå–æ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰
                filename=$(basename "$source_file")
                echo "å¤„ç†æ–‡ä»¶: $filename"
                
                # æå–æ—¥æœŸï¼ˆå‡è®¾æ–‡ä»¶åæ ¼å¼ä¸ºYYYY-MM-DD.mdï¼‰
                if [[ $filename =~ ^([0-9]{4}-[0-9]{2}-[0-9]{2})\.md$ ]]; then
                  file_date="${BASH_REMATCH[1]}"
                  year_month="${file_date:0:7}"  # æå–YYYY-MMéƒ¨åˆ†
                  
                  echo "æ–‡ä»¶æ—¥æœŸ: $file_date, å¹´æœˆ: $year_month"
                  
                  # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
                  target_dir="content/cn/${year_month}"
                  mkdir -p "$target_dir"
                  
                  target_file="$target_dir/$filename"
                  
                  # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                  need_update=false
                  if [ ! -f "$target_file" ]; then
                    echo "âœ… æ–°æ–‡ä»¶ï¼Œéœ€è¦åˆ›å»º: $target_file"
                    need_update=true
                  else
                    # æ¯”è¾ƒæ–‡ä»¶å¤§å°
                    source_size=$(wc -c < "$source_file")
                    target_size=$(wc -c < "$target_file")
                    if [ "$source_size" -ne "$target_size" ]; then
                      echo "ğŸ“ æ–‡ä»¶å¤§å°ä¸åŒï¼Œéœ€è¦æ›´æ–°: $target_file"
                      echo "æºæ–‡ä»¶: ${source_size} bytes, ç›®æ ‡æ–‡ä»¶: ${target_size} bytes"
                      need_update=true
                    else
                      echo "â„¹ï¸ æ–‡ä»¶å·²å­˜åœ¨ä¸”å¤§å°ç›¸åŒ: $target_file"
                    fi
                  fi
                  
                  if [ "$need_update" = true ]; then
                    echo "ğŸ”„ å¤„ç†æ–‡ä»¶: $source_file -> $target_file"
                    
                    # ç”ŸæˆHugo Front Matter
                    cat > "$target_file" << EOF
---
title: "AIæ´å¯Ÿæ—¥æŠ¥ - ${file_date}"
date: ${file_date}T08:00:00+08:00
draft: false
tags: ["AI", "äººå·¥æ™ºèƒ½", "æŠ€æœ¯", "æ—¥æŠ¥"]
categories: ["AIæ—¥æŠ¥"]
weight: 1
---

EOF
                    
                    # æ·»åŠ åŸå§‹å†…å®¹
                    cat "$source_file" >> "$target_file"
                    
                    echo "âœ… æ–‡ä»¶å·²å¤„ç†: $target_file"
                    files_processed=$((files_processed + 1))
                    has_updates=true
                    
                    # åˆ›å»ºæœˆä»½ç´¢å¼•æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                    index_file="$target_dir/_index.md"
                    if [ ! -f "$index_file" ]; then
                      cat > "$index_file" << EOF
---
title: "${year_month} AIæ—¥æŠ¥"
date: ${year_month}-01T00:00:00+08:00
type: docs
weight: 1
---

# ${year_month} AIæ´å¯Ÿæ—¥æŠ¥

æœ¬æœˆçš„AIè¡Œä¸šåŠ¨æ€å’ŒæŠ€æœ¯è¶‹åŠ¿æ±‡æ€»ã€‚

EOF
                      echo "ğŸ“„ åˆ›å»ºç´¢å¼•æ–‡ä»¶: $index_file"
                    fi
                  fi
                else
                  echo "âš ï¸ æ–‡ä»¶åæ ¼å¼ä¸ç¬¦åˆYYYY-MM-DD.md: $filename"
                fi
              fi
            done
            
            echo "ğŸ“Š å¤„ç†ç»“æœ:"
            echo "å¤„ç†çš„æ–‡ä»¶æ•°é‡: $files_processed"
            echo "æ˜¯å¦æœ‰æ›´æ–°: $has_updates"
            
            # è®¾ç½®è¾“å‡ºå˜é‡
            echo "has_updates=$has_updates" >> $GITHUB_OUTPUT
            echo "files_processed=$files_processed" >> $GITHUB_OUTPUT
            
          else
            echo "âŒ æºä»“åº“ä¸­æ²¡æœ‰dailyç›®å½•"
            echo "æºä»“åº“æ ¹ç›®å½•å†…å®¹:"
            ls -la source-repo/ || echo "æ— æ³•åˆ—å‡ºæºä»“åº“ç›®å½•"
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "files_processed=0" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.sync-content.outputs.has_updates == 'true'
        run: |
          echo "ğŸ“¤ å‡†å¤‡æäº¤æ›´æ”¹..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ˜¾ç¤ºå½“å‰çŠ¶æ€
          echo "å½“å‰gitçŠ¶æ€:"
          git status
          
          echo "å¾…æäº¤çš„æ–‡ä»¶:"
          git add .
          git status --porcelain
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            echo "âœ… å‘ç°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
            git commit -m "ğŸ¤– æ‰¹é‡åŒæ­¥AIæ—¥æŠ¥å†…å®¹

            - æ¥æº: april8000/ai-insight-daily-token
            - å¤„ç†æ–‡ä»¶æ•°: ${{ steps.sync-content.outputs.files_processed }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            - åŒæ­¥æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
            "
            git push
            echo "ğŸ‰ å†…å®¹å·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“!"
          fi

      - name: Summary
        if: always()
        run: |
          echo "ğŸ“Š æ‰§è¡Œæ€»ç»“:"
          echo "å·¥ä½œæµè§¦å‘æ–¹å¼: ${{ github.event_name }}"
          echo "æ˜¯å¦æœ‰æ›´æ–°: ${{ steps.sync-content.outputs.has_updates }}"
          echo "å¤„ç†æ–‡ä»¶æ•°: ${{ steps.sync-content.outputs.files_processed }}"
          
          echo ""
          echo "ğŸ“ å½“å‰contentç›®å½•ç»“æ„:"
          if [ -d "content" ]; then
            find content -type f -name "*.md" | sort
          else
            echo "contentç›®å½•ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "ğŸ“… æºä»“åº“dailyç›®å½•å†…å®¹:"
          if [ -d "source-repo/daily" ]; then
            ls -la source-repo/daily/
          else
            echo "æºä»“åº“dailyç›®å½•ä¸å­˜åœ¨"
          fi
