name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create complete content with full display
        run: |
          echo "ğŸ¨ å¼€å§‹åˆ›å»ºå®Œæ•´å†…å®¹å±•ç¤º..."
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p content/cn
          mkdir -p assets/css
          mkdir -p static/images
          
          # åˆ›å»ºæ ¹ç›®å½•é¦–é¡µï¼ˆç®€åŒ–ç‰ˆï¼‰
          cat > content/_index.md << 'EOF'
          ---
          title: AIæ´å¯Ÿæ—¥æŠ¥
          ---
          
          # AIæ´å¯Ÿæ—¥æŠ¥
          
          **ç²¾é€‰AIæ–°é—»ä¸æ·±åº¦åˆ†æ** | æ¯æ—¥ä¸ºæ‚¨è¿‡æ»¤ä¿¡æ¯å™ªéŸ³ï¼Œæä¾›æœ€ç²¾é€‰çš„AIèµ„è®¯
          
          [æŸ¥çœ‹æœ€æ–°æ—¥æŠ¥ â†’](/cn/)
          EOF
          
          # åˆ›å»ºcnç›®å½•ä¸»é¡µ
          cat > content/cn/_index.md << 'EOF'
          ---
          title: AIæ´å¯Ÿæ—¥æŠ¥
          type: docs
          sidebar:
            open: true
          ---
          
          # AIæ´å¯Ÿæ—¥æŠ¥
          
          > ğŸ¤– **AIèµ„è®¯** | ğŸ“° **æ¯æ—¥æ—©è¯»** | ğŸŒ **å…¨ç½‘æ•°æ®èšåˆ** | ğŸ”¬ **å‰æ²¿ç§‘å­¦æ¢ç´¢** | ğŸ’¡ **å¼€æºåˆ›æ–°åŠ›é‡** | ğŸš€ **AIä¸äººç±»æœªæ¥**
          
          æ¬¢è¿æ¥åˆ°AIæ´å¯Ÿæ—¥æŠ¥ï¼è¿™é‡Œä¸ºæ‚¨æä¾›æ¯æ—¥ç²¾é€‰çš„AIèµ„è®¯å’Œæ·±åº¦åˆ†æã€‚
          
          ## ğŸ”¥ æœ€æ–°åŠ¨æ€
          
          æµè§ˆå·¦ä¾§çš„æ—¥æœŸå¯¼èˆªæŸ¥çœ‹æœ€æ–°çš„AIæ—¥æŠ¥å†…å®¹ï¼Œæ¯æ—¥æ›´æ–°ï¼Œç²¾å½©ä¸æ–­ï¼
          
          ---
          
          ### ğŸ“Š å†…å®¹ç‰¹è‰²
          
          - ğŸ¯ **ç²¾å‡†ç­›é€‰** - ä»æµ·é‡ä¿¡æ¯ä¸­ç­›é€‰æœ€æœ‰ä»·å€¼çš„AIèµ„è®¯
          - ğŸ”¥ **çƒ­ç‚¹è¿½è¸ª** - å®æ—¶è·Ÿè¸ªAIè¡Œä¸šæœ€æ–°åŠ¨æ€å’Œçªç ´
          - ğŸ’¼ **å•†ä¸šæ´å¯Ÿ** - æ·±å…¥åˆ†æAIæŠ•èµ„ã€èèµ„ã€å•†ä¸šè¶‹åŠ¿  
          - ğŸ”“ **å¼€æºèšç„¦** - ç²¾é€‰GitHubçƒ­é—¨AIé¡¹ç›®å’Œå·¥å…·
          - ğŸ“š **å­¦æœ¯å‰æ²¿** - æ±‡æ€»æœ€æ–°AIç ”ç©¶è®ºæ–‡å’ŒæŠ€æœ¯çªç ´
          - ğŸ¨ **åˆ›æ„å·¥å…·** - æ¨èæœ€æ–°AIåˆ›ä½œå·¥å…·å’Œåº”ç”¨
          EOF
          
          # å¤„ç†æ—¥æŠ¥æ–‡ä»¶ - å®Œæ•´å†…å®¹æ˜¾ç¤º
          find source-repo/daily -maxdepth 1 -type f -name "*.md" 2>/dev/null | sort -r | head -20 | while read -r SOURCE_FILE_PATH; do
            if [ -f "$SOURCE_FILE_PATH" ]; then
              FILENAME=$(basename "$SOURCE_FILE_PATH")
              DATE_PART=$(echo "$FILENAME" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')
              YEAR_MONTH=$(echo "$DATE_PART" | cut -c1-7)
              
              # æŒ‰å¹´æœˆåˆ›å»ºç›®å½•
              TARGET_DIR="content/cn/${YEAR_MONTH}"
              mkdir -p "$TARGET_DIR"
              TARGET_FILE="${TARGET_DIR}/${FILENAME}"
              
              echo "--- å¤„ç†æ–‡ä»¶: ${FILENAME} â†’ ${TARGET_FILE} ---"
              
              # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
              NEEDS_UPDATE=true
              if [ -f "$TARGET_FILE" ]; then
                SOURCE_SIZE=$(stat -c%s "$SOURCE_FILE_PATH" 2>/dev/null || stat -f%z "$SOURCE_FILE_PATH" 2>/dev/null)
                if [ -f "$TARGET_FILE" ]; then
                  TARGET_SIZE=$(tail -n +30 "$TARGET_FILE" 2>/dev/null | wc -c)
                  if [ "$SOURCE_SIZE" -eq "$TARGET_SIZE" ]; then
                    echo "æ–‡ä»¶å¤§å°ç›¸åŒï¼Œè·³è¿‡æ›´æ–°"
                    NEEDS_UPDATE=false
                  fi
                fi
              fi
              
              if [ "$NEEDS_UPDATE" = true ]; then
                # è¯»å–å®Œæ•´å†…å®¹
                FULL_CONTENT=$(cat "$SOURCE_FILE_PATH")
                
                # æ ¹æ®å†…å®¹åˆ†æç”Ÿæˆåˆ†ç±»æ ‡ç­¾
                CATEGORY_TAGS="\`AIèµ„è®¯\` | \`æ¯æ—¥æ—©è¯»\`"
                
                # æ ¹æ®å†…å®¹æ·»åŠ ç‰¹å®šåˆ†ç±»æ ‡ç­¾
                if echo "$FULL_CONTENT" | grep -qi "OpenAI\|ChatGPT\|GPT\|Claude\|Gemini"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`å¤§æ¨¡å‹å‰æ²¿\`"
                fi
                if echo "$FULL_CONTENT" | grep -qi "æŠ•èµ„\|èèµ„\|IPO\|ä¸Šå¸‚\|äº¿ç¾å…ƒ\|ä¼°å€¼"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`å•†ä¸šåŠ¨æ€\`"
                fi
                if echo "$FULL_CONTENT" | grep -qi "å¼€æº\|GitHub\|ä»£ç \|å¼€å‘è€…"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`å¼€æºåˆ›æ–°åŠ›é‡\`"
                fi
                if echo "$FULL_CONTENT" | grep -qi "ç ”ç©¶\|è®ºæ–‡\|å­¦æœ¯\|å¤§å­¦\|å®éªŒå®¤"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`å‰æ²¿ç§‘å­¦æ¢ç´¢\`"
                fi
                if echo "$FULL_CONTENT" | grep -qi "æœºå™¨äºº\|Robot\|äººå½¢æœºå™¨äºº\|è‡ªåŠ¨é©¾é©¶"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`AIä¸äººç±»æœªæ¥\`"
                fi
                if echo "$FULL_CONTENT" | grep -qi "å›¾åƒç”Ÿæˆ\|æ–‡ç”Ÿå›¾\|è§†é¢‘ç”Ÿæˆ\|AIGC"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`åˆ›æ„AIå·¥å…·\`"
                fi
                if echo "$FULL_CONTENT" | grep -qi "åŒ»ç–—\|åŒ»å­¦\|å¥åº·\|æ•™è‚²\|é‡‘è"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`è¡Œä¸šåº”ç”¨\`"
                fi
                if echo "$FULL_CONTENT" | grep -qi "è°·æ­Œ\|å¾®è½¯\|Meta\|è‹¹æœ\|äºšé©¬é€Š\|ç™¾åº¦\|é˜¿é‡Œ\|è…¾è®¯"; then
                  CATEGORY_TAGS="${CATEGORY_TAGS} | \`è¡Œä¸šè‡ªç”±å‘å£°\`"
                fi
                
                # æ€»æ˜¯æ·»åŠ æ•°æ®èšåˆæ ‡ç­¾
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`å…¨ç½‘æ•°æ®èšåˆ\`"
                
                # ç”ŸæˆFront Matterï¼ˆåŒ…å«å®Œæ•´çš„åŸä½œè€…é£æ ¼é…ç½®ï¼‰
                cat > "$TARGET_FILE" << EOF
          ---
          linkTitle: $(echo $DATE_PART | cut -c6-10)-æ—¥æŠ¥
          title: "AIæ´å¯Ÿæ—¥æŠ¥ - ${DATE_PART}"
          date: ${DATE_PART}T08:00:00+08:00
          draft: false
          weight: 1
          type: docs
          sidebar:
            open: true
          description: "${DATE_PART}çš„AIè¡Œä¸šåŠ¨æ€ã€æŠ€æœ¯å‘å±•å’Œé‡è¦èµ„è®¯æ±‡æ€»"
          keywords: ["AI", "äººå·¥æ™ºèƒ½", "ChatGPT", "æœºå™¨å­¦ä¹ ", "æ·±åº¦å­¦ä¹ ", "ç§‘æŠ€"]
          breadcrumbs: false
          comments: true
          ---
          
          ## AIæ´å¯Ÿæ—¥æŠ¥ ${DATE_PART}
          
          > ${CATEGORY_TAGS} | [è®¿é—®ç½‘é¡µç‰ˆâ†—ï¸](https://april8000.github.io/Hextra-AI-Insight-Daily/)
          
          EOF
                
                # æ·»åŠ å®Œæ•´çš„åŸå§‹å†…å®¹ï¼ˆä¸è·³è¿‡ä»»ä½•å†…å®¹ï¼‰
                echo "" >> "$TARGET_FILE"
                cat "$SOURCE_FILE_PATH" >> "$TARGET_FILE"
                echo "âœ… å®Œæ•´å†…å®¹å·²æ·»åŠ : ${TARGET_FILE}"
                
                # åˆ›å»ºæˆ–æ›´æ–°æœˆä»½ç´¢å¼•æ–‡ä»¶
                MONTH_INDEX="${TARGET_DIR}/_index.md"
                if [ ! -f "$MONTH_INDEX" ]; then
                  cat > "$MONTH_INDEX" << EOF
          ---
          title: "${YEAR_MONTH} AIæ—¥æŠ¥"
          date: ${YEAR_MONTH}-01T00:00:00+08:00
          type: docs
          sidebar:
            open: true
          weight: 1
          description: "${YEAR_MONTH}æœˆä»½AIè¡Œä¸šåŠ¨æ€æ±‡æ€»"
          ---
          
          # ${YEAR_MONTH} AIæ´å¯Ÿæ—¥æŠ¥
          
          > ğŸ“… **${YEAR_MONTH}** | ğŸ”¥ **æœˆåº¦ç²¾é€‰** | ğŸ“Š **æ•°æ®æ±‡æ€»** | ğŸš€ **è¶‹åŠ¿åˆ†æ**
          
          æœ¬æœˆçš„AIè¡Œä¸šåŠ¨æ€å’ŒæŠ€æœ¯è¶‹åŠ¿æ±‡æ€»ï¼š
          
          ## ğŸ“ˆ æœ¬æœˆäº®ç‚¹
          
          - ğŸ”¥ **è¡Œä¸šçƒ­ç‚¹** - é‡å¤§äº‹ä»¶å’Œçªç ´æ€§è¿›å±•  
          - ğŸ› ï¸ **æŠ€æœ¯äº§å“** - æ–°å·¥å…·ã€æ–°å¹³å°ã€æ–°åŠŸèƒ½å‘å¸ƒ
          - ğŸ“Š **å•†ä¸šåŠ¨æ€** - æŠ•èµ„èèµ„ã€å¹¶è´­é‡ç»„ã€IPOä¸Šå¸‚
          - ğŸ§  **å­¦æœ¯ç ”ç©¶** - è®ºæ–‡å‘å¸ƒã€å®éªŒçªç ´ã€æŠ€æœ¯åˆ›æ–°
          - ğŸ’¡ **å¼€æºé¡¹ç›®** - GitHubçƒ­é—¨é¡¹ç›®å’Œå¼€å‘è€…å·¥å…·
          - ğŸ¯ **è¡Œä¸šåº”ç”¨** - å‚ç›´é¢†åŸŸAIåº”ç”¨æ¡ˆä¾‹å’Œè¶‹åŠ¿
          
          ---
          
          *æµè§ˆå·¦ä¾§å¯¼èˆªæŸ¥çœ‹æœ¬æœˆå„æ—¥çš„è¯¦ç»†AIèµ„è®¯å†…å®¹*
          EOF
                  echo "âœ… ç¾åŒ–æœˆä»½ç´¢å¼•å·²åˆ›å»º: ${MONTH_INDEX}"
                fi
              fi
            fi
          done
          
          echo "--- å®Œæ•´å†…å®¹å¤„ç†å®Œæˆ ---"
          
          # æ˜¾ç¤ºå¤„ç†ç»“æœ
          echo "=== å¤„ç†ç»“æœç»Ÿè®¡ ==="
          echo "ğŸ“ å†…å®¹ç›®å½•æ•°: $(find content/cn -type d | wc -l)"
          echo "ğŸ“„ markdownæ–‡ä»¶æ•°: $(find content/cn -name "*.md" -type f | wc -l)"
          echo "ğŸ“Š å¹³å‡æ–‡ä»¶å¤§å°: $(find content/cn -name "*.md" -type f -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo '0') bytes"
          
          # æ˜¾ç¤ºæœ€æ–°æ–‡ä»¶
          echo "=== æœ€æ–°å¤„ç†çš„æ–‡ä»¶ ==="
          find content/cn -name "*.md" -type f | sort | tail -5

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ğŸ“° å®Œæ•´å†…å®¹å±•ç¤ºï¼šä¿ç•™æ‰€æœ‰åŸå§‹å†…å®¹ - $(date +%Y-%m-%d-%H-%M)"
            git push
            echo "âœ… å®Œæ•´å†…å®¹å·²åŒæ­¥å¹¶æ¨é€åˆ°ä»“åº“"
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "ğŸ‰ å®Œæ•´å†…å®¹å±•ç¤ºæ›´æ–°å®Œæˆï¼"
          echo "âœ¨ æ”¹è¿›åŠŸèƒ½:"
          echo "   ğŸ“° ä¿ç•™å®Œæ•´åŸå§‹å†…å®¹ï¼ˆä¸æˆªæ–­ï¼‰"
          echo "   ğŸ·ï¸ æ™ºèƒ½åˆ†ç±»æ ‡ç­¾ç³»ç»Ÿ"
          echo "   ğŸ“± ä¼˜åŒ–çš„ä¾§è¾¹æ å¯¼èˆª"
          echo "   ğŸ¨ ç¾åŒ–çš„é¡µé¢å¸ƒå±€"
          echo "   ğŸ“Š è¯¦ç»†çš„å†…å®¹ç»Ÿè®¡"
          echo "   ğŸ”— å®Œæ•´çš„å›¾ç‰‡å’Œé“¾æ¥å±•ç¤º"
          echo "ğŸ“Š å†…å®¹ç»Ÿè®¡ï¼š"
          echo "   ğŸ“„ æ€»æ–‡ä»¶æ•°: $(find content/cn -name "*.md" -type f | wc -l)"
          echo "ğŸ”— ç½‘ç«™å°†åœ¨å‡ åˆ†é’Ÿå†…æ›´æ–°ï¼Œå±•ç°å®Œæ•´ä¸°å¯Œçš„å†…å®¹ï¼"
