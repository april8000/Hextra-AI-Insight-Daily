name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]  # å“åº”åŽç«¯è§¦å‘çš„äº‹ä»¶
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '30 0 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´8:30è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
  push:
    branches: [main]  # å½“ä¸»åˆ†æ”¯æœ‰æŽ¨é€æ—¶ä¹Ÿæ£€æŸ¥æ›´æ–°

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      # æ‹‰å–æºä»“åº“çš„æœ€æ–°å†…å®¹
      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'  # æ‚¨çš„æ•°æ®æºä»“åº“
          ref: 'main'  # æ ¹æ®æ‚¨çš„å®žé™…åˆ†æ”¯è°ƒæ•´
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
      - name: Check for new content
        id: check-updates
        run: |
          echo "ðŸ” æ£€æŸ¥æºä»“åº“ä¸­çš„æ–°å†…å®¹..."
          
          if [ -d "source-repo/daily" ]; then
            # æŸ¥æ‰¾æœ€è¿‘3å¤©çš„æ–‡ä»¶ï¼Œä»¥é˜²é”™è¿‡
            for i in 0 1 2; do
              CHECK_DATE=$(date -d "-$i days" +%Y-%m-%d)
              if [ -f "source-repo/daily/${CHECK_DATE}.md" ]; then
                YEAR_MONTH=$(date -d "-$i days" +%Y-%m)
                
                # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ä¸”å†…å®¹ç›¸åŒ
                TARGET_FILE="content/cn/${YEAR_MONTH}/${CHECK_DATE}.md"
                
                if [ ! -f "$TARGET_FILE" ]; then
                  echo "æ‰¾åˆ°æ–°æ–‡ä»¶: ${CHECK_DATE}.md"
                  echo "has_updates=true" >> $GITHUB_OUTPUT
                  echo "latest_date=${CHECK_DATE}" >> $GITHUB_OUTPUT
                  echo "year_month=${YEAR_MONTH}" >> $GITHUB_OUTPUT
                  break
                else
                  # æ¯”è¾ƒæ–‡ä»¶å†…å®¹å·®å¼‚ï¼ˆè·³è¿‡å‰å‡ è¡Œçš„Front Matterï¼‰
                  SOURCE_CONTENT=$(tail -n +10 "source-repo/daily/${CHECK_DATE}.md" 2>/dev/null || echo "")
                  TARGET_CONTENT=$(tail -n +10 "$TARGET_FILE" 2>/dev/null || echo "")
                  
                  if [ "$SOURCE_CONTENT" != "$TARGET_CONTENT" ]; then
                    echo "æ–‡ä»¶å†…å®¹æœ‰æ›´æ–°: ${CHECK_DATE}.md"
                    echo "has_updates=true" >> $GITHUB_OUTPUT
                    echo "latest_date=${CHECK_DATE}" >> $GITHUB_OUTPUT
                    echo "year_month=${YEAR_MONTH}" >> $GITHUB_OUTPUT
                    break
                  fi
                fi
              fi
            done
            
            if [ "${has_updates:-false}" != "true" ]; then
              echo "æ²¡æœ‰å‘çŽ°æ–°å†…å®¹æˆ–æ›´æ–°"
              echo "has_updates=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ æºä»“åº“ä¸­æ²¡æœ‰dailyç›®å½•"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

      # å¤„ç†å¹¶è½¬æ¢å†…å®¹æ ¼å¼
      - name: Process and convert content
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          LATEST_DATE=${{ steps.check-updates.outputs.latest_date }}
          YEAR_MONTH=${{ steps.check-updates.outputs.year_month }}
          
          echo "ðŸ“ å¤„ç†æ—¥æœŸ: ${LATEST_DATE}"
          echo "ðŸ“ ç›®æ ‡ç›®å½•: ${YEAR_MONTH}"
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p "content/cn/${YEAR_MONTH}"
          mkdir -p "content/en/${YEAR_MONTH}" 
          mkdir -p "content/ja/${YEAR_MONTH}"
          
          # å¤„ç†ä¸­æ–‡ç‰ˆæœ¬
          if [ -f "source-repo/daily/${LATEST_DATE}.md" ]; then
            echo "ðŸ”„ å¤„ç†ä¸­æ–‡ç‰ˆæœ¬..."
            
            # ç”ŸæˆHugo Front Matter
            cat > "content/cn/${YEAR_MONTH}/${LATEST_DATE}.md" << EOF
---
title: "AIæ´žå¯Ÿæ—¥æŠ¥ - ${LATEST_DATE}"
date: ${LATEST_DATE}T08:00:00+08:00
draft: false
tags: ["AI", "äººå·¥æ™ºèƒ½", "æŠ€æœ¯", "æ—¥æŠ¥"]
categories: ["AIæ—¥æŠ¥"]
weight: 1
---

EOF
            
            # æ·»åŠ åŽŸå§‹å†…å®¹ï¼Œä½†è·³è¿‡å¯èƒ½çš„é‡å¤æ ‡é¢˜
            tail -n +2 "source-repo/daily/${LATEST_DATE}.md" >> "content/cn/${YEAR_MONTH}/${LATEST_DATE}.md"
            
            echo "âœ… ä¸­æ–‡ç‰ˆæœ¬å·²å¤„ç†: content/cn/${YEAR_MONTH}/${LATEST_DATE}.md"
          fi
          
          # å¦‚æžœæœ‰è‹±æ–‡æˆ–æ—¥æ–‡ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥ç±»ä¼¼å¤„ç†
          # è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•

      # æ›´æ–°ç´¢å¼•æ–‡ä»¶
      - name: Update index files
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          YEAR_MONTH=${{ steps.check-updates.outputs.year_month }}
          
          # æ›´æ–°æœˆä»½ç´¢å¼•æ–‡ä»¶
          if [ ! -f "content/cn/${YEAR_MONTH}/_index.md" ]; then
            cat > "content/cn/${YEAR_MONTH}/_index.md" << EOF
---
title: "${YEAR_MONTH} AIæ—¥æŠ¥"
date: ${YEAR_MONTH}-01T00:00:00+08:00
type: docs
weight: 1
---

# ${YEAR_MONTH} AIæ´žå¯Ÿæ—¥æŠ¥

æœ¬æœˆçš„AIè¡Œä¸šåŠ¨æ€å’ŒæŠ€æœ¯è¶‹åŠ¿æ±‡æ€»ã€‚

EOF
          fi

      # æäº¤æ›´æ”¹
      - name: Commit and push changes
        if: steps.check-updates.outputs.has_updates == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ðŸ¤– è‡ªåŠ¨æ›´æ–°AIæ—¥æŠ¥å†…å®¹ - ${{ steps.check-updates.outputs.latest_date }}

            - æ¥æº: april8000/ai-insight-daily-token
            - æ—¥æœŸ: ${{ steps.check-updates.outputs.latest_date }}
            - è§¦å‘æ–¹å¼: ${{ github.event_name }}
            "
            git push
            echo "âœ… å†…å®¹å·²æ›´æ–°å¹¶æŽ¨é€åˆ°ä»“åº“"
          fi

      # å‘é€å®Œæˆé€šçŸ¥
      - name: Notify completion
        if: always()
        run: |
          if [ "${{ steps.check-updates.outputs.has_updates }}" == "true" ]; then
            echo "ðŸŽ‰ å‰ç«¯å†…å®¹æ›´æ–°å®Œæˆï¼"
            echo "ðŸ“… æ›´æ–°æ—¥æœŸ: ${{ steps.check-updates.outputs.latest_date }}"
            echo "ðŸ”— ç½‘ç«™å°†åœ¨å‡ åˆ†é’Ÿå†…è‡ªåŠ¨é‡æ–°éƒ¨ç½²"
          else
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°å†…å®¹æ›´æ–°"
          fi
