name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup optimized content with enhanced visuals
        run: |
          echo "🎨 开始优化版本内容设置..."
          
          # 确保所有必要目录存在
          mkdir -p content/cn
          mkdir -p assets/css
          mkdir -p static/images
          
          # 创建增强版自定义CSS
          cat > assets/css/custom.css << 'EOF'
          /* AI洞察日报 - 增强版视觉样式 */
          
          /* 1. 基础样式优化 */
          h1:first-of-type {
            display: none;
          }
          
          .content {
            max-width: none !important;
            overflow: visible !important;
            line-height: 1.8 !important;
          }
          
          /* 2. 分类标签超级美化 */
          .content blockquote {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.05));
            border: none;
            border-left: 5px solid #ff9900;
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin: 2rem 0;
            position: relative;
            box-shadow: 0 8px 32px rgba(255, 153, 0, 0.15);
            backdrop-filter: blur(10px);
          }
          
          .content blockquote::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff9900, #ffaa33, #ff9900);
            border-radius: 12px 12px 0 0;
            animation: shimmer 3s infinite;
          }
          
          @keyframes shimmer {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
          }
          
          .content blockquote p {
            margin: 0 !important;
            color: #ff9900 !important;
            font-weight: 600 !important;
            font-size: 1rem !important;
            text-shadow: 0 1px 2px rgba(255, 153, 0, 0.3);
          }
          
          .content blockquote code {
            background-color: rgba(255, 153, 0, 0.25) !important;
            color: #ff6600 !important;
            padding: 3px 8px !important;
            border-radius: 6px !important;
            font-weight: 700 !important;
            border: 1px solid rgba(255, 153, 0, 0.4) !important;
            box-shadow: 0 2px 4px rgba(255, 153, 0, 0.2);
          }
          
          /* 3. 新闻条目超级美化 */
          .content ol li,
          .content ul li {
            margin-bottom: 2rem !important;
            padding: 1.5rem !important;
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.05), rgba(255, 153, 0, 0.02)) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(255, 153, 0, 0.2) !important;
            border-left: 4px solid #ff9900 !important;
            transition: all 0.4s ease !important;
            position: relative !important;
            box-shadow: 0 4px 16px rgba(255, 153, 0, 0.1) !important;
          }
          
          .content ol li:hover,
          .content ul li:hover {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.12), rgba(255, 153, 0, 0.05)) !important;
            transform: translateX(8px) translateY(-2px) !important;
            box-shadow: 0 8px 32px rgba(255, 153, 0, 0.25) !important;
            border-left-width: 6px !important;
          }
          
          .content ol li::before,
          .content ul li::before {
            content: '📰';
            position: absolute;
            top: -8px;
            left: 1rem;
            background: #ff9900;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(255, 153, 0, 0.3);
          }
          
          /* 4. 标题超级美化 */
          .content h3 {
            color: #ff9900 !important;
            background: linear-gradient(90deg, rgba(255, 153, 0, 0.1), transparent);
            border: none;
            border-left: 6px solid #ff9900;
            padding: 1rem 1.5rem !important;
            border-radius: 8px;
            margin: 2.5rem 0 1.5rem 0 !important;
            position: relative;
            box-shadow: 0 4px 16px rgba(255, 153, 0, 0.15);
            font-size: 1.3rem !important;
            font-weight: 700 !important;
          }
          
          .content h3::before {
            content: '🔥';
            margin-right: 0.8rem;
            font-size: 1.1rem;
          }
          
          .content h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #ff9900, transparent);
          }
          
          /* 5. 链接超级美化 */
          .content a {
            color: #ff9900 !important;
            text-decoration: none !important;
            font-weight: 600 !important;
            border-bottom: 2px solid transparent !important;
            transition: all 0.3s ease !important;
            position: relative !important;
            padding: 2px 4px !important;
            border-radius: 4px !important;
          }
          
          .content a:hover {
            color: #ffffff !important;
            background: linear-gradient(45deg, #ff9900, #ffaa33) !important;
            border-bottom-color: transparent !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.4) !important;
          }
          
          .content a::after {
            content: ' 🔗';
            font-size: 0.8em;
            opacity: 0.7;
          }
          
          /* 6. 强调文本美化 */
          .content strong {
            color: #ff9900 !important;
            font-weight: 700 !important;
            background: linear-gradient(45deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.05)) !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            box-shadow: 0 1px 3px rgba(255, 153, 0, 0.2) !important;
          }
          
          /* 7. 图片超级美化 */
          .content img {
            margin: 2rem auto !important;
            border-radius: 16px !important;
            max-width: 100% !important;
            height: auto !important;
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15) !important;
            transition: all 0.4s ease !important;
            border: 3px solid rgba(255, 153, 0, 0.2) !important;
          }
          
          .content img:hover {
            transform: scale(1.03) !important;
            box-shadow: 0 20px 60px rgba(255, 153, 0, 0.3) !important;
            border-color: #ff9900 !important;
          }
          
          /* 8. 代码美化 */
          .content code {
            background: linear-gradient(45deg, rgba(255, 153, 0, 0.15), rgba(255, 153, 0, 0.08)) !important;
            color: #ff6600 !important;
            padding: 3px 8px !important;
            border-radius: 6px !important;
            font-size: 0.9em !important;
            font-weight: 600 !important;
            border: 1px solid rgba(255, 153, 0, 0.3) !important;
            box-shadow: 0 1px 3px rgba(255, 153, 0, 0.2) !important;
          }
          
          /* 9. 分隔线美化 */
          .content hr {
            border: none !important;
            height: 3px !important;
            background: linear-gradient(90deg, transparent, #ff9900, transparent) !important;
            margin: 3rem 0 !important;
            border-radius: 2px !important;
          }
          
          /* 10. 暗色主题超级优化 */
          html.dark .content {
            color: #f0f0f0 !important;
          }
          
          html.dark .content h2,
          html.dark .content h3,
          html.dark .content h4 {
            color: #ff9900 !important;
          }
          
          html.dark .content ol li,
          html.dark .content ul li {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.12), rgba(255, 153, 0, 0.05)) !important;
            color: #f0f0f0 !important;
            border-color: rgba(255, 153, 0, 0.3) !important;
          }
          
          html.dark .content ol li:hover,
          html.dark .content ul li:hover {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.2), rgba(255, 153, 0, 0.08)) !important;
          }
          
          /* 11. 响应式超级优化 */
          @media (max-width: 768px) {
            .content {
              padding: 1rem !important;
            }
            
            .content ol li,
            .content ul li {
              padding: 1rem !important;
              margin-bottom: 1.5rem !important;
            }
            
            .content blockquote {
              padding: 1rem 1.5rem !important;
            }
            
            .content h3 {
              font-size: 1.1rem !important;
              padding: 0.8rem 1rem !important;
            }
          }
          
          /* 12. 加载动画 */
          .content {
            animation: fadeInUp 0.8s ease-out;
          }
          
          @keyframes fadeInUp {
            from {
              opacity: 0;
              transform: translateY(30px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          /* 13. 特殊效果 */
          .content ol li:nth-child(odd),
          .content ul li:nth-child(odd) {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.08), rgba(255, 153, 0, 0.03)) !important;
          }
          
          .content ol li:nth-child(even),
          .content ul li:nth-child(even) {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.05), rgba(255, 153, 0, 0.02)) !important;
          }
          EOF
          
          echo "✅ 增强版CSS已创建"
          
          # 创建根目录首页
          cat > content/_index.md << 'EOF'
          ---
          title: AI洞察日报
          ---
          
          # AI洞察日报
          
          **精选AI新闻与深度分析** | 每日为您过滤信息噪音，提供最精选的AI资讯
          
          [查看最新日报 →](/cn/)
          EOF
          
          # 创建cn目录主页
          cat > content/cn/_index.md << 'EOF'
          ---
          title: AI洞察日报
          type: docs
          sidebar:
            open: true
          ---
          
          # AI洞察日报
          
          > 🤖 **AI资讯** | 📰 **每日早读** | 🌐 **全网数据聚合** | 🔬 **前沿科学探索** | 💡 **开源创新力量** | 🚀 **AI与人类未来**
          
          欢迎来到AI洞察日报！这里为您提供每日精选的AI资讯和深度分析。
          
          ## 🔥 最新动态
          
          浏览左侧的日期导航查看最新的AI日报内容，每日更新，精彩不断！
          
          ### 📈 今日亮点
          - 💡 **深度分析** - 专业解读AI行业趋势
          - 🔗 **原文链接** - 一键跳转到新闻源页面
          - 🎨 **视觉优化** - 精美的阅读体验
          - 📱 **响应式设计** - 完美适配各种设备
          EOF
          
          # 处理日报文件 - 增强版处理
          find source-repo/daily -maxdepth 1 -type f -name "*.md" 2>/dev/null | sort -r | head -20 | while read -r SOURCE_FILE_PATH; do
            if [ -f "$SOURCE_FILE_PATH" ]; then
              FILENAME=$(basename "$SOURCE_FILE_PATH")
              DATE_PART=$(echo "$FILENAME" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')
              YEAR_MONTH=$(echo "$DATE_PART" | cut -c1-7)
              
              # 按年月创建目录
              TARGET_DIR="content/cn/${YEAR_MONTH}"
              mkdir -p "$TARGET_DIR"
              TARGET_FILE="${TARGET_DIR}/${FILENAME}"
              
              echo "--- 增强处理文件: ${FILENAME} → ${TARGET_FILE} ---"
              
              # 读取完整原始内容
              ORIGINAL_CONTENT=$(cat "$SOURCE_FILE_PATH")
              
              # 处理内容以确保链接完整显示
              PROCESSED_CONTENT=$(echo "$ORIGINAL_CONTENT" | sed 's/\[\([^]]*\)(\([^)]*\))\]/[\1](\2)/g')
              
              # 根据内容生成分类标签
              CATEGORY_TAGS="\`AI资讯\` | \`每日早读\`"
              
              if echo "$ORIGINAL_CONTENT" | grep -qi "OpenAI\|ChatGPT\|GPT\|Claude\|Gemini"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`大模型前沿\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "投资\|融资\|IPO\|上市\|亿美元"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`商业动态\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "开源\|GitHub\|代码"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`开源创新力量\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "研究\|论文\|学术"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`前沿科学探索\`"
              fi
              if echo "$ORIGINAL_CONTENT" | grep -qi "机器人\|自动驾驶"; then
                CATEGORY_TAGS="${CATEGORY_TAGS} | \`AI与人类未来\`"
              fi
              
              CATEGORY_TAGS="${CATEGORY_TAGS} | \`全网数据聚合\`"
              
              # 创建完整的文件内容
              cat > "$TARGET_FILE" << EOF
          ---
          linkTitle: $(echo $DATE_PART | cut -c6-10)-日报
          title: "AI洞察日报 - ${DATE_PART}"
          date: ${DATE_PART}T08:00:00+08:00
          draft: false
          weight: 1
          type: docs
          sidebar:
            open: true
          description: "${DATE_PART}的AI行业动态、技术发展和重要资讯汇总"
          breadcrumbs: false
          comments: true
          ---
          
          ## AI洞察日报 ${DATE_PART}
          
          > ${CATEGORY_TAGS} | [访问网页版↗️](https://april8000.github.io/Hextra-AI-Insight-Daily/)
          
          ${PROCESSED_CONTENT}
          EOF
              
              echo "✅ 增强版内容文件已创建: ${TARGET_FILE}"
              
              # 创建月份索引
              MONTH_INDEX="${TARGET_DIR}/_index.md"
              if [ ! -f "$MONTH_INDEX" ]; then
                cat > "$MONTH_INDEX" << EOF
          ---
          title: "${YEAR_MONTH} AI日报"
          date: ${YEAR_MONTH}-01T00:00:00+08:00
          type: docs
          sidebar:
            open: true
          weight: 1
          description: "${YEAR_MONTH}月份AI行业动态汇总"
          ---
          
          # ${YEAR_MONTH} AI洞察日报
          
          > 📅 **${YEAR_MONTH}** | 🔥 **月度精选** | 📊 **数据汇总** | 🎯 **趋势分析**
          
          ## 📈 本月亮点
          
          本月的AI行业动态和技术趋势汇总，精选重要资讯：
          
          - 🔥 **行业热点** - 重大突破和里程碑事件
          - 🛠️ **技术创新** - 新产品、新功能、新平台发布  
          - 📊 **商业动态** - 投资融资、并购重组、市场分析
          - 🧠 **学术前沿** - 论文发布、研究突破、技术进展
          - 💡 **开源生态** - GitHub热门项目和开发者工具
          - 🎯 **行业应用** - 垂直领域的AI落地实践案例
          
          ---
          
          *点击左侧导航浏览本月各日的详细AI资讯内容*
          EOF
                echo "✅ 增强版月份索引已创建: ${MONTH_INDEX}"
              fi
            fi
          done
          
          echo "--- 增强版设置完成 ---"
          
          # 显示文件统计
          echo "=== 增强版统计 ==="
          echo "📄 内容文件: $(find content -name "*.md" -type f | wc -l)"
          echo "🎨 样式文件: $(find assets -name "*.css" -type f | wc -l)"
          echo "📊 平均文件大小: $(find content/cn -name "*.md" -type f -exec wc -c {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo '0') bytes"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          if git diff --staged --quiet; then
            echo "ℹ️ 没有需要提交的更改"
          else
            git commit -m "✨ 增强版视觉优化：超级美化+完整内容+链接支持 - $(date +%Y-%m-%d-%H-%M)"
            git push
            echo "✅ 增强版已推送"
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "🎉 增强版视觉优化完成！"
          echo "✨ 超级功能:"
          echo "   🎨 超级美化CSS（渐变、阴影、动画）"
          echo "   📰 完整内容展示（不截断）"
          echo "   🔗 原文链接支持（一键跳转）"
          echo "   💫 悬停动画效果"
          echo "   📱 完美响应式设计"
          echo "   🌗 增强暗色主题"
          echo "   ⚡ 加载动画效果"
          echo "📊 统计: $(find content/cn -name "*.md" -type f | wc -l) 个内容文件"
