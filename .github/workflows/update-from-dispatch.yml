name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'
  push:
    branches: [main]

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Process and convert content for Hextra
        run: |
          echo "üîç ÂºÄÂßãÂ§ÑÁêÜHextra‰∏ªÈ¢òÁöÑÂÜÖÂÆπÂêåÊ≠•..."
          
          # Á°Æ‰øùÁõÆÊ†áÁõÆÂΩïÂ≠òÂú®
          mkdir -p content/docs
          
          # ÂàõÂª∫docs‰∏ªÈ°µ
          cat > content/docs/_index.md << 'EOF'
          ---
          title: AIÊ¥ûÂØüÊó•Êä•
          type: docs
          sidebar:
            open: true
          ---
          
          # AIÊ¥ûÂØüÊó•Êä•
          
          Ê¨¢ËøéÊù•Âà∞AIÊ¥ûÂØüÊó•Êä•ÔºÅËøôÈáå‰∏∫ÊÇ®Êèê‰æõÊØèÊó•Á≤æÈÄâÁöÑAIËµÑËÆØÂíåÊ∑±Â∫¶ÂàÜÊûê„ÄÇ
          
          ## ÊúÄÊñ∞Êó•Êä•
          
          ÊµèËßàÂ∑¶‰æßËèúÂçïÊü•ÁúãÊúÄÊñ∞ÁöÑAIÊó•Êä•ÂÜÖÂÆπ„ÄÇ
          EOF
          
          # Â§ÑÁêÜÊó•Êä•Êñá‰ª∂
          PROCESSED_COUNT=0
          find source-repo/daily -maxdepth 1 -type f -name "*.md" 2>/dev/null | sort -r | head -20 | while read -r SOURCE_FILE_PATH; do
            if [ -f "$SOURCE_FILE_PATH" ]; then
              FILENAME=$(basename "$SOURCE_FILE_PATH")
              DATE_PART=$(echo "$FILENAME" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')
              YEAR_MONTH=$(echo "$DATE_PART" | cut -c1-7)
              
              # ÊåâÂπ¥ÊúàÂàõÂª∫ÁõÆÂΩï
              TARGET_DIR="content/docs/${YEAR_MONTH}"
              mkdir -p "$TARGET_DIR"
              TARGET_FILE="${TARGET_DIR}/${FILENAME}"
              
              echo "--- Â§ÑÁêÜÊñá‰ª∂: ${FILENAME} ‚Üí ${TARGET_FILE} ---"
              
              # Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊõ¥Êñ∞
              NEEDS_UPDATE=true
              if [ -f "$TARGET_FILE" ]; then
                SOURCE_SIZE=$(wc -c < "$SOURCE_FILE_PATH")
                TARGET_CONTENT_SIZE=$(tail -n +9 "$TARGET_FILE" 2>/dev/null | wc -c)
                if [ "$SOURCE_SIZE" -eq "$TARGET_CONTENT_SIZE" ]; then
                  echo "Êñá‰ª∂Â§ßÂ∞èÁõ∏ÂêåÔºåË∑≥ËøáÊõ¥Êñ∞"
                  NEEDS_UPDATE=false
                fi
              fi
              
              if [ "$NEEDS_UPDATE" = true ]; then
                # ÁîüÊàêHextraÂÖºÂÆπÁöÑFront Matter
                cat > "$TARGET_FILE" << EOF
          ---
          title: "AIÊ¥ûÂØüÊó•Êä• - ${DATE_PART}"
          date: ${DATE_PART}T08:00:00+08:00
          draft: false
          tags: ["AI", "‰∫∫Â∑•Êô∫ËÉΩ", "ÊäÄÊúØ", "Êó•Êä•"]
          categories: ["AIÊó•Êä•"]
          type: docs
          weight: $(date -d "$DATE_PART" +%s)
          ---
          
          EOF
                
                # Ê∑ªÂä†ÂéüÂßãÂÜÖÂÆπ
                cat "$SOURCE_FILE_PATH" >> "$TARGET_FILE"
                echo "‚úÖ Êñá‰ª∂Â∑≤Êõ¥Êñ∞: ${TARGET_FILE}"
                PROCESSED_COUNT=$((PROCESSED_COUNT + 1))
                
                # ÂàõÂª∫Âπ¥ÊúàÁ¥¢ÂºïÊñá‰ª∂
                MONTH_INDEX="${TARGET_DIR}/_index.md"
                if [ ! -f "$MONTH_INDEX" ]; then
                  cat > "$MONTH_INDEX" << EOF
          ---
          title: "${YEAR_MONTH} AIÊó•Êä•"
          date: ${YEAR_MONTH}-01T00:00:00+08:00
          type: docs
          sidebar:
            open: true
          weight: $(date -d "${YEAR_MONTH}-01" +%s)
          ---
          
          # ${YEAR_MONTH} AIÊ¥ûÂØüÊó•Êä•
          
          Êú¨ÊúàÁöÑAIË°å‰∏öÂä®ÊÄÅÂíåÊäÄÊúØË∂ãÂäøÊ±áÊÄª„ÄÇ
          EOF
                  echo "‚úÖ Êúà‰ªΩÁ¥¢ÂºïÂ∑≤ÂàõÂª∫: ${MONTH_INDEX}"
                fi
              fi
            fi
          done
          
          echo "--- ÂÜÖÂÆπÂ§ÑÁêÜÂÆåÊàê ---"
          echo "Â§ÑÁêÜÊñá‰ª∂Êï∞: ${PROCESSED_COUNT}"
          
          # ÊòæÁ§∫ÊúÄÁªàÁõÆÂΩïÁªìÊûÑ
          echo "=== ÊúÄÁªàÁõÆÂΩïÁªìÊûÑ ==="
          find content -type f -name "*.md" | head -10
          
          # Ê£ÄÊü•ÂÖ≥ÈîÆÊñá‰ª∂
          echo "=== Ê£ÄÊü•ÂÖ≥ÈîÆÊñá‰ª∂ ==="
          ls -la content/docs/ || echo "docsÁõÆÂΩï‰∏∫Á©∫"
          ls -la content/docs/*/ || echo "Ê≤°ÊúâÊúà‰ªΩÁõÆÂΩï"

      - name: Update site configuration
        run: |
          # Á°Æ‰øùhugo.yamlÈÖçÁΩÆÊ≠£Á°Æ
          if [ ! -f "hugo.yaml" ] || ! grep -q "baseURL:" hugo.yaml; then
            echo "Êõ¥Êñ∞HugoÈÖçÁΩÆ..."
            cat > hugo.yaml << 'EOF'
          baseURL: https://april8000.github.io/Hextra-AI-Insight-Daily/
          title: AIÊ¥ûÂØüÊó•Êä•
          
          theme: hextra
          module:
            imports:
              - path: github.com/imfing/hextra
          
          markup:
            goldmark:
              renderer:
                unsafe: true
            highlight:
              noClasses: false
          
          menu:
            main:
              - name: AIÊó•Êä•
                pageRef: /docs
                weight: 1
              - name: ÂÖ≥‰∫é
                pageRef: /about
                weight: 2
              - name: GitHub
                url: "https://github.com/april8000/Hextra-AI-Insight-Daily"
                weight: 3
                params:
                  icon: github
              - name: Search
                weight: 4
                params:
                  type: search
          
          params:
            navbar:
              displayTitle: true
              displayLogo: false
            footer:
              displayCopyright: false
              displayPoweredBy: true
            editURL:
              enable: false
          EOF
            echo "‚úÖ HugoÈÖçÁΩÆÂ∑≤Êõ¥Êñ∞"
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Ê≤°ÊúâÈúÄË¶ÅÊèê‰∫§ÁöÑÊõ¥Êîπ"
          else
            git commit -m "ü§ñ Ëá™Âä®ÂêåÊ≠•AIÊó•Êä•ÂÜÖÂÆπ - $(date +%Y-%m-%d-%H-%M)"
            git push
            echo "‚úÖ ÂÜÖÂÆπÂ∑≤ÂêåÊ≠•Âπ∂Êé®ÈÄÅÂà∞‰ªìÂ∫ì"
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "üéâ AIÊó•Êä•ÂÜÖÂÆπÂêåÊ≠•ÂÆåÊàêÔºÅ"
          echo "üìä ÁªüËÆ°‰ø°ÊÅØÔºö"
          find content -name "*.md" -type f | wc -l | xargs echo "ÊÄªÊñá‰ª∂Êï∞Ôºö"
          echo "üîó ÁΩëÁ´ôÂ∞ÜÂú®Âá†ÂàÜÈíüÂÜÖËá™Âä®Êõ¥Êñ∞"
