name: Update Content from Backend Dispatch

on:
  repository_dispatch:
    types: [daily-updated]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'
  push:
    branches: [main]

env:
  TZ: Asia/Shanghai

jobs:
  update-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4

      - name: Clone source repository
        uses: actions/checkout@v4
        with:
          repository: 'april8000/ai-insight-daily-token'
          ref: 'main'
          path: 'source-repo'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Process and convert content for Hextra-AI-Insight-Daily with enhancements
        run: |
          echo "ðŸ” å¼€å§‹å¤„ç†å¢žå¼ºç‰ˆHextra-AI-Insight-Dailyçš„å†…å®¹åŒæ­¥..."
          
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
          mkdir -p content/cn
          
          # åˆ›å»ºæˆ–æ›´æ–°ä¸»é¡µ
          cat > content/cn/_index.md << 'EOF'
          ---
          title: AIæ´žå¯Ÿæ—¥æŠ¥
          type: docs
          sidebar:
            open: true
          ---
          
          # AIæ´žå¯Ÿæ—¥æŠ¥
          
          æ¬¢è¿Žæ¥åˆ°AIæ´žå¯Ÿæ—¥æŠ¥ï¼è¿™é‡Œä¸ºæ‚¨æä¾›æ¯æ—¥ç²¾é€‰çš„AIèµ„è®¯å’Œæ·±åº¦åˆ†æžã€‚
          
          ## æµè§ˆå†…å®¹
          - [ðŸ“… æœ€æ–°æ—¥æŠ¥](/cn/)
          - [ðŸ·ï¸ æŒ‰æ ‡ç­¾æµè§ˆ](/cn/tags/)
          - [ðŸ“‚ æŒ‰åˆ†ç±»æµè§ˆ](/cn/categories/)
          EOF
          
          # å¤„ç†æ—¥æŠ¥æ–‡ä»¶åˆ°cnç›®å½•
          find source-repo/daily -maxdepth 1 -type f -name "*.md" 2>/dev/null | while read -r SOURCE_FILE_PATH; do
            if [ -f "$SOURCE_FILE_PATH" ]; then
              FILENAME=$(basename "$SOURCE_FILE_PATH")
              DATE_PART=$(echo "$FILENAME" | sed -E 's/([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/')
              YEAR_MONTH=$(echo "$DATE_PART" | cut -c1-7)
              
              # æŒ‰çŽ°æœ‰ç»“æž„åˆ›å»ºç›®å½• content/cn/YYYY-MM/
              TARGET_DIR="content/cn/${YEAR_MONTH}"
              mkdir -p "$TARGET_DIR"
              TARGET_FILE="${TARGET_DIR}/${FILENAME}"
              
              echo "--- å¤„ç†æ–‡ä»¶: ${FILENAME} â†’ ${TARGET_FILE} ---"
              
              # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
              NEEDS_UPDATE=true
              if [ -f "$TARGET_FILE" ]; then
                SOURCE_CONTENT=$(cat "$SOURCE_FILE_PATH" 2>/dev/null || echo "")
                TARGET_CONTENT=$(tail -n +20 "$TARGET_FILE" 2>/dev/null || echo "")
                if [ "$SOURCE_CONTENT" = "$TARGET_CONTENT" ]; then
                  echo "æ–‡ä»¶å†…å®¹ç›¸åŒï¼Œè·³è¿‡æ›´æ–°"
                  NEEDS_UPDATE=false
                fi
              fi
              
              if [ "$NEEDS_UPDATE" = true ]; then
                # è¯»å–å†…å®¹è¿›è¡Œæ™ºèƒ½åˆ†æž
                CONTENT=$(cat "$SOURCE_FILE_PATH")
                
                # åŸºç¡€æ ‡ç­¾å’Œåˆ†ç±»
                TAGS='["AI", "äººå·¥æ™ºèƒ½", "æŠ€æœ¯", "æ—¥æŠ¥"'
                CATEGORIES='["AIæ—¥æŠ¥"'
                
                # æ™ºèƒ½æ ‡ç­¾åˆ†æžï¼ˆä¿æŒçŽ°æœ‰é€»è¾‘ï¼Œæ·»åŠ æ›´å¤šï¼‰
                if echo "$CONTENT" | grep -qi "OpenAI\|ChatGPT\|GPT\|o1"; then
                  TAGS="${TAGS}, \"OpenAI\", \"ChatGPT\", \"GPT\""
                  CATEGORIES="${CATEGORIES}, \"å¤§æ¨¡åž‹\""
                fi
                if echo "$CONTENT" | grep -qi "è°·æ­Œ\|Google\|Gemini\|Bard"; then
                  TAGS="${TAGS}, \"Google\", \"è°·æ­Œ\", \"Gemini\""
                  CATEGORIES="${CATEGORIES}, \"ç§‘æŠ€å·¨å¤´\""
                fi
                if echo "$CONTENT" | grep -qi "å¾®è½¯\|Microsoft\|Copilot"; then
                  TAGS="${TAGS}, \"å¾®è½¯\", \"Microsoft\", \"Copilot\""
                  CATEGORIES="${CATEGORIES}, \"ç§‘æŠ€å·¨å¤´\""
                fi
                if echo "$CONTENT" | grep -qi "Meta\|Facebook"; then
                  TAGS="${TAGS}, \"Meta\", \"Facebook\""
                  CATEGORIES="${CATEGORIES}, \"ç§‘æŠ€å·¨å¤´\""
                fi
                if echo "$CONTENT" | grep -qi "è‹¹æžœ\|Apple"; then
                  TAGS="${TAGS}, \"è‹¹æžœ\", \"Apple\""
                  CATEGORIES="${CATEGORIES}, \"ç§‘æŠ€å·¨å¤´\""
                fi
                if echo "$CONTENT" | grep -qi "äºšé©¬é€Š\|Amazon"; then
                  TAGS="${TAGS}, \"äºšé©¬é€Š\", \"Amazon\""
                  CATEGORIES="${CATEGORIES}, \"ç§‘æŠ€å·¨å¤´\""
                fi
                if echo "$CONTENT" | grep -qi "è‡ªåŠ¨é©¾é©¶\|æ— äººé©¾é©¶\|ç‰¹æ–¯æ‹‰\|Tesla"; then
                  TAGS="${TAGS}, \"è‡ªåŠ¨é©¾é©¶\", \"ç‰¹æ–¯æ‹‰\""
                  CATEGORIES="${CATEGORIES}, \"è‡ªåŠ¨é©¾é©¶\""
                fi
                if echo "$CONTENT" | grep -qi "æœºå™¨å­¦ä¹ \|æ·±åº¦å­¦ä¹ \|ML\|DL\|ç¥žç»ç½‘ç»œ"; then
                  TAGS="${TAGS}, \"æœºå™¨å­¦ä¹ \", \"æ·±åº¦å­¦ä¹ \""
                  CATEGORIES="${CATEGORIES}, \"æœºå™¨å­¦ä¹ \""
                fi
                if echo "$CONTENT" | grep -qi "èŠ¯ç‰‡\|GPU\|CPU\|è‹±ä¼Ÿè¾¾\|NVIDIA\|AMD"; then
                  TAGS="${TAGS}, \"èŠ¯ç‰‡\", \"ç¡¬ä»¶\", \"NVIDIA\""
                  CATEGORIES="${CATEGORIES}, \"ç¡¬ä»¶\""
                fi
                if echo "$CONTENT" | grep -qi "æŠ•èµ„\|èžèµ„\|IPO\|ä¸Šå¸‚\|äº¿ç¾Žå…ƒ\|ä¼°å€¼"; then
                  TAGS="${TAGS}, \"æŠ•èµ„\", \"èžèµ„\", \"å•†ä¸š\""
                  CATEGORIES="${CATEGORIES}, \"å•†ä¸š\""
                fi
                if echo "$CONTENT" | grep -qi "å¼€æº\|GitHub\|ä»£ç \|å¼€å‘è€…"; then
                  TAGS="${TAGS}, \"å¼€æº\", \"GitHub\", \"å¼€å‘è€…\""
                  CATEGORIES="${CATEGORIES}, \"å¼€æº\""
                fi
                if echo "$CONTENT" | grep -qi "ç ”ç©¶\|è®ºæ–‡\|å­¦æœ¯\|å¤§å­¦\|å®žéªŒå®¤"; then
                  TAGS="${TAGS}, \"ç ”ç©¶\", \"å­¦æœ¯\", \"è®ºæ–‡\""
                  CATEGORIES="${CATEGORIES}, \"ç ”ç©¶\""
                fi
                if echo "$CONTENT" | grep -qi "æœºå™¨äºº\|Robot\|äººå½¢æœºå™¨äºº"; then
                  TAGS="${TAGS}, \"æœºå™¨äºº\", \"äººå½¢æœºå™¨äºº\""
                  CATEGORIES="${CATEGORIES}, \"æœºå™¨äºº\""
                fi
                if echo "$CONTENT" | grep -qi "è¯­è¨€æ¨¡åž‹\|LLM\|å¤§æ¨¡åž‹\|ç”Ÿæˆå¼AI"; then
                  TAGS="${TAGS}, \"è¯­è¨€æ¨¡åž‹\", \"å¤§æ¨¡åž‹\", \"ç”Ÿæˆå¼AI\""
                  CATEGORIES="${CATEGORIES}, \"è¯­è¨€æ¨¡åž‹\""
                fi
                if echo "$CONTENT" | grep -qi "å›¾åƒç”Ÿæˆ\|æ–‡ç”Ÿå›¾\|Midjourney\|DALL-E\|Stable Diffusion"; then
                  TAGS="${TAGS}, \"å›¾åƒç”Ÿæˆ\", \"æ–‡ç”Ÿå›¾\", \"AIGC\""
                  CATEGORIES="${CATEGORIES}, \"å›¾åƒç”Ÿæˆ\""
                fi
                if echo "$CONTENT" | grep -qi "è§†é¢‘ç”Ÿæˆ\|Sora\|è§†é¢‘AI"; then
                  TAGS="${TAGS}, \"è§†é¢‘ç”Ÿæˆ\", \"Sora\", \"è§†é¢‘AI\""
                  CATEGORIES="${CATEGORIES}, \"è§†é¢‘ç”Ÿæˆ\""
                fi
                if echo "$CONTENT" | grep -qi "åŒ»ç–—\|åŒ»å­¦\|å¥åº·\|è¯Šæ–­"; then
                  TAGS="${TAGS}, \"åŒ»ç–—AI\", \"åŒ»å­¦\", \"å¥åº·\""
                  CATEGORIES="${CATEGORIES}, \"åŒ»ç–—\""
                fi
                if echo "$CONTENT" | grep -qi "æ•™è‚²\|å­¦ä¹ \|åŸ¹è®­"; then
                  TAGS="${TAGS}, \"æ•™è‚²AI\", \"å­¦ä¹ \""
                  CATEGORIES="${CATEGORIES}, \"æ•™è‚²\""
                fi
                if echo "$CONTENT" | grep -qi "é‡‘èž\|é“¶è¡Œ\|æ”¯ä»˜"; then
                  TAGS="${TAGS}, \"é‡‘èžAI\", \"é“¶è¡Œ\""
                  CATEGORIES="${CATEGORIES}, \"é‡‘èž\""
                fi
                
                TAGS="${TAGS}]"
                CATEGORIES="${CATEGORIES}]"
                
                # ç”Ÿæˆå¢žå¼ºçš„Front Matter
                cat > "$TARGET_FILE" << EOF
          ---
          title: "AIæ´žå¯Ÿæ—¥æŠ¥ - ${DATE_PART}"
          date: ${DATE_PART}T08:00:00+08:00
          draft: false
          tags: ${TAGS}
          categories: ${CATEGORIES}
          weight: 1
          type: docs
          sidebar:
            open: true
          description: "${DATE_PART}çš„AIè¡Œä¸šåŠ¨æ€ã€æŠ€æœ¯å‘å±•å’Œé‡è¦èµ„è®¯æ±‡æ€»"
          ---
          
          EOF
                
                # æ·»åŠ åŽŸå§‹å†…å®¹
                cat "$SOURCE_FILE_PATH" >> "$TARGET_FILE"
                echo "âœ… æ–‡ä»¶å·²æ›´æ–°: ${TARGET_FILE}"
                
                # åˆ›å»ºæˆ–æ›´æ–°æœˆä»½ç´¢å¼•æ–‡ä»¶
                MONTH_INDEX="${TARGET_DIR}/_index.md"
                if [ ! -f "$MONTH_INDEX" ]; then
                  cat > "$MONTH_INDEX" << EOF
          ---
          title: "${YEAR_MONTH} AIæ—¥æŠ¥"
          date: ${YEAR_MONTH}-01T00:00:00+08:00
          type: docs
          sidebar:
            open: true
          weight: 1
          description: "${YEAR_MONTH}æœˆä»½AIè¡Œä¸šåŠ¨æ€æ±‡æ€»"
          ---
          
          # ${YEAR_MONTH} AIæ´žå¯Ÿæ—¥æŠ¥
          
          æœ¬æœˆçš„AIè¡Œä¸šåŠ¨æ€å’ŒæŠ€æœ¯è¶‹åŠ¿æ±‡æ€»ï¼ŒåŒ…æ‹¬ï¼š
          - ðŸ”¥ è¡Œä¸šçƒ­ç‚¹æ–°é—»  
          - ðŸ› ï¸ æŠ€æœ¯äº§å“å‘å¸ƒ
          - ðŸ“Š å¸‚åœºæŠ•èµ„åŠ¨æ€
          - ðŸ§  å­¦æœ¯ç ”ç©¶è¿›å±•
          - ðŸ’¡ å¼€æºé¡¹ç›®æŽ¨è
          EOF
                  echo "âœ… æœˆä»½ç´¢å¼•å·²åˆ›å»º: ${MONTH_INDEX}"
                fi
              fi
            fi
          done
          
          echo "--- å¢žå¼ºå†…å®¹å¤„ç†å®Œæˆ ---"
          
          # æ˜¾ç¤ºæœ€ç»ˆç›®å½•ç»“æž„
          echo "=== æœ€ç»ˆç›®å½•ç»“æž„ ==="
          find content/cn -type f -name "*.md" | head -10
          
          # ç»Ÿè®¡ä¿¡æ¯
          echo "=== ç»Ÿè®¡ä¿¡æ¯ ==="
          echo "æ€»æ–‡ä»¶æ•°: $(find content/cn -name "*.md" -type f | wc -l)"
          echo "æœ€æ–°æ–‡ä»¶: $(find content/cn -name "*.md" -type f | sort | tail -3)"

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add .
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "ðŸš€ å¢žå¼ºå†…å®¹åŒæ­¥ï¼šæ™ºèƒ½æ ‡ç­¾+ä¸°å¯Œåˆ†ç±» - $(date +%Y-%m-%d-%H-%M)"
            git push
            echo "âœ… å¢žå¼ºå†…å®¹å·²åŒæ­¥å¹¶æŽ¨é€åˆ°ä»“åº“"
          fi

      - name: Notify completion
        if: always()
        run: |
          echo "ðŸŽ‰ å¢žå¼ºç‰ˆHextra-AI-Insight-Daily å†…å®¹åŒæ­¥å®Œæˆï¼"
          echo "âœ¨ æ–°åŠŸèƒ½:"
          echo "   ðŸ·ï¸ æ™ºèƒ½æ ‡ç­¾è¯†åˆ« (OpenAI, Google, å¾®è½¯ç­‰)"
          echo "   ðŸ“‚ ä¸°å¯Œåˆ†ç±»ç³»ç»Ÿ (å¤§æ¨¡åž‹, ç¡¬ä»¶, å•†ä¸šç­‰)"  
          echo "   ðŸ–¼ï¸ å›¾ç‰‡å†…å®¹ä¿ç•™"
          echo "   ðŸ“± ä¾§è¾¹æ å¯¼èˆª"
          echo "ðŸ“Š ç»Ÿè®¡ä¿¡æ¯ï¼š"
          find content/cn -name "*.md" -type f | wc -l | xargs echo "æ€»æ–‡ä»¶æ•°ï¼š"
          echo "ðŸ”— ç½‘ç«™å°†åœ¨å‡ åˆ†é’Ÿå†…è‡ªåŠ¨æ›´æ–°"
